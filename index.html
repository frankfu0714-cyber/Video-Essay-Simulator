<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Video Essay/Interview Simulator</title>
  <style>
    * { box-sizing: border-box; margin:0; padding:0; }
    body { font-family: "Microsoft JhengHei", system-ui, sans-serif; background:#9B59B6; color:#111; }

    /* ===== Shared ===== */
    .btn {
      border: none; border-radius: 10px;
      padding: 12px 14px; font-weight: 700;
      cursor: pointer;
    }
    .btn-primary { background:#2d1b69; color:#fff; }
    .btn-ghost { background:rgba(255,255,255,0.15); color:#fff; border:1px solid rgba(255,255,255,0.25); }
    .btn-danger { background:#b91c1c; color:#fff; }
    .pill { padding:8px 10px; border-radius:999px; background:rgba(0,0,0,0.35); color:#fff; font-weight:700; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .muted { opacity:0.85; }

    /* ===== Home Screen ===== */
    #homeScreen {
      min-height: 100vh;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      align-items: center;
    }
    .title { text-align:center; color:#fff; }
    .title h1 { font-size: 2.2rem; }
    .card {
      width: min(960px, 100%);
      background: #fff;
      border-radius: 14px;
      padding: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
    }
    .grid {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 720px){ .grid { grid-template-columns: 1fr; } }

    label { display:flex; flex-direction:column; gap:6px; font-weight:700; }
    input, select, textarea {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ddd;
      font-size: 1rem;
    }
    textarea { min-height: 84px; resize: vertical; }

    /* ===== Record Screen ===== */
    #recordScreen {
      display:none;
      position: relative;
      min-height: 100vh;
      overflow: hidden;
      background:#000;
    }

    /* Camera background video */
    #cameraBg {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: contrast(1.05) saturate(1.05);
      /* âœ… é¡åƒï¼ˆå·¦å³ç›¸åï¼‰ */
  transform: scaleX(-1) scale(1.02);
    }

    /* Dark overlay for readability */
    .shade {
      position:absolute; inset:0;
      background: linear-gradient(
        to bottom,
        rgba(0,0,0,0.55),
        rgba(0,0,0,0.35),
        rgba(0,0,0,0.6)
      );
      pointer-events:none;
    }

    /* Top bar */
    .topbar {
      position:absolute; top:14px; left:14px; right:14px;
      display:flex; justify-content:space-between; align-items:center;
      gap: 10px;
      z-index: 5;
    }

    /* Bottom controls */
    .controls {
      position:absolute; left:14px; right:14px; bottom:14px;
      display:flex; justify-content:space-between; align-items:center;
      gap: 10px; flex-wrap:wrap;
      z-index: 5;
    }

    .panel {
      background: rgba(0,0,0,0.40);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 14px;
      padding: 12px;
      color:#fff;
      backdrop-filter: blur(8px);
    }

    /* Big countdown */
    #countdownOverlay {
      position:absolute; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 6;
    }
    #countdownNumber {
      font-size: min(18vw, 140px);
      color:#fff;
      font-weight: 900;
      text-shadow: 0 10px 40px rgba(0,0,0,0.6);
      letter-spacing: 2px;
    }

    /* Question overlay */
    .questionBox {
      position:absolute;
      left: 14px;
      right: 14px;
      top: 120px;
      z-index: 5;
      display:flex;
      justify-content:center;
    }
    .questionInner {
      width: min(960px, 100%);
      text-align: center;
      font-size: clamp(18px, 2.2vw, 26px);
      font-weight: 800;
      color:#fff;
      padding: 12px 14px;
      border-radius: 14px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.15);
      backdrop-filter: blur(8px);
    }

    /* Playback modal-like screen */
    #playbackScreen {
      display:none;
      position:absolute;
      inset:0;
      z-index: 10;
      background: rgba(0,0,0,0.75);
      padding: 18px;
    }
    .playbackCard {
      width: min(980px, 100%);
      margin: 0 auto;
      background: rgba(0,0,0,0.50);
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 16px;
      padding: 14px;
      color:#fff;
      backdrop-filter: blur(10px);
    }
    #playbackVideo {
      width: 100%;
      max-height: 65vh;
      border-radius: 14px;
      background:#000;
    }
    /* ===== REC pulsing + progress ===== */
#recBadge {
  display: none;
  align-items: center;
  gap: 10px;
}

.recDot {
  width: 12px;
  height: 12px;
  border-radius: 999px;
  background: #ff2d2d;
  box-shadow: 0 0 0 rgba(255,45,45,0.6);
  animation: recPulse 1.1s infinite;
}

@keyframes recPulse {
  0%   { transform: scale(1);   box-shadow: 0 0 0 0 rgba(255,45,45,0.65); opacity: 1; }
  70%  { transform: scale(1.18); box-shadow: 0 0 0 12px rgba(255,45,45,0); opacity: 0.95; }
  100% { transform: scale(1);   box-shadow: 0 0 0 0 rgba(255,45,45,0); opacity: 1; }
}

.recText {
  font-weight: 900;
  letter-spacing: 1px;
}

/* progress bar */
.progressWrap {
  width: min(420px, 60vw);
  height: 10px;
  border-radius: 999px;
  background: rgba(255,255,255,0.18);
  overflow: hidden;
  border: 1px solid rgba(255,255,255,0.18);
}

.progressFill {
  height: 100%;
  width: 0%;
  background: rgba(255,255,255,0.92);
  border-radius: 999px;
  transition: width 0.2s linear;
}

/* "recording vibe" on camera bg */
#recordScreen.recording #cameraBg {
  filter: contrast(1.15) saturate(1.18);
}

/* subtle vignette while recording */
#recordScreen.recording .shade {
  background: radial-gradient(circle at center,
    rgba(0,0,0,0.35),
    rgba(0,0,0,0.55)
  );
}
.commentItem{
  border:1px solid #eee;
  border-radius:12px;
  padding:12px;
  margin-bottom:10px;
}
.commentMeta{
  display:flex;
  justify-content:space-between;
  gap:10px;
  font-weight:900;
}
.commentTime{
  font-weight:700;
  opacity:0.65;
  font-size:0.9rem;
}
.commentBody{
  margin-top:6px;
  line-height:1.6;
  white-space:pre-wrap;
}

/* ===== Personal Links ===== */
.personal-links {
  text-align: center;
}

.link-icons {
  display: flex;
  justify-content: center;
  gap: 26px;
}

.link-icons a {
  width: 42px;
  height: 42px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  background: #f3f3f3;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.link-icons a:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.18);
}

.link-icons img {
  width: 22px;
  height: 22px;
  filter: invert(0.15);
}
/* ===== Personal Links (Centered & Compact) ===== */
.personal-links-wrap {
  display: flex;
  justify-content: center;
  margin-top: 16px;
}

.personal-links {
  width: fit-content;          /* âœ… é—œéµï¼šä¸è¦æ’æ»¿ */
  padding: 14px 22px;
  text-align: center;
}

.link-icons {
  display: flex;
  justify-content: center;
  gap: 20px;                   /* ç¨å¾®ç¸®çŸ­ */
}

.link-icons a {
  width: 38px;                 /* ç¸®å°ä¸€é» */
  height: 38px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  background: #f3f3f3;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.link-icons a:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 14px rgba(0,0,0,0.18);
}

.link-icons img {
  width: 20px;
  height: 20px;
  filter: invert(0.15);
}

.creator-text {
  margin-top: 8px;
  font-size: 0.9rem;           /* å­—ä¹Ÿç¸®ä¸€é» */
}
    
/* ===== Mobile text overflow fix ===== */
@media (max-width: 480px) {
  .creator-text,
  .playbackCard,
  .panel,
  .questionInner {
    word-break: break-word;
    overflow-wrap: anywhere;
  }
}

    /* ===== Fix comment form overflow on mobile ===== */
@media (max-width: 600px) {
  /* ä½ ç•™è¨€è¡¨å–®ç”¨ .grid å…©æ¬„æ’ç‰ˆï¼Œæ‰‹æ©Ÿæ”¹æˆå–®æ¬„ */
  #homeScreen .grid {
    grid-template-columns: 1fr !important;
  }

  /* è®“è¼¸å…¥æ¡†ä¸æœƒæ’å‡ºå®¹å™¨ */
  #commentName,
  #commentText {
    width: 100% !important;
    max-width: 100% !important;
  }

  /* é˜²æ­¢å¡ç‰‡å…§å®¹è¢«æ’çˆ†ï¼ˆä¿éšªï¼‰ */
  #homeScreen .card {
    overflow: hidden;
  }
}
/* ===== Mobile FINAL: question never overlaps CAM/MIC + fits one screen ===== */
@media (max-width: 600px) {

  /* ä¸Šæ–¹æ¢æ›´ç·Šæ¹Š */
  .topbar {
    top: 10px !important;
    left: 10px !important;
    right: 10px !important;
    gap: 8px !important;
    align-items: flex-start !important;
  }

  /* è®“ topbar å·¦å³å…©å¡Šåœ¨å°è¢å¹•èƒ½æ”¾å¾—ä¸‹ï¼šå¿…è¦æ™‚æ›è¡Œ */
  .topbar .row {
    gap: 8px !important;
    flex-wrap: wrap !important;
  }

  /* å³ä¸Šæ§åˆ¶é¢æ¿ç¸®å° */
  .topbar .panel {
    padding: 8px 10px !important;
    border-radius: 12px !important;
  }

  .topbar .panel label {
    font-size: 12px !important;
    gap: 4px !important;
  }

  .topbar .panel select {
    padding: 6px 8px !important;
    border-radius: 10px !important;
    font-size: 12px !important;
  }

  .topbar .panel .btn {
    padding: 8px 10px !important;
    border-radius: 10px !important;
    font-size: 12px !important;
  }

  /* å·¦ä¸Š pill ç¸®å° */
  .pill {
    padding: 6px 8px !important;
    font-size: 12px !important;
  }

  /* é€²åº¦æ¢ç¸®çŸ­ï¼Œé¿å…æ“ çˆ† */
  .progressWrap {
    width: 45vw !important;
    height: 8px !important;
  }

  /* âœ… é—œéµï¼šé¡Œç›®æ°¸é åœ¨ topbar ä¸‹æ–¹ï¼Œä¸é‡ç–Š CAM/MIC/Back */
  .questionBox {
    top: 118px !important;   /* å¦‚æœé‚„é‡ç–Šï¼šæ”¹å¤§ä¸€é» 130ï¼›å¤ªä½ï¼šæ”¹å°ä¸€é» 110 */
    left: 10px !important;
    right: 10px !important;
    z-index: 6 !important;
  }

  .questionInner {
    width: 100% !important;
    max-width: 100% !important;
    padding: 10px 12px !important;
    font-size: 16px !important;
    line-height: 1.35 !important;
    text-align: center !important;

    overflow-wrap: anywhere !important;
    word-break: break-word !important;
  }

  /* ä¸‹æ–¹æ§åˆ¶åˆ—ç¸®å°ï¼Œç¢ºä¿åŒç•«é¢çœ‹å¾—åˆ° */
  /* ===== Mobile: move Prep/Record panel upward ===== */
@media (max-width: 600px) {
  .controls {
    left: 10px !important;
    right: 10px !important;
    bottom: 32px !important;   /* âœ… å¾€ä¸Šç§»ï¼ˆåŸæœ¬ 10pxï¼‰ */
    gap: 8px !important;
  }
}


  .controls .panel {
    padding: 8px 10px !important;
    border-radius: 12px !important;
    font-size: 12px !important;
  }

  /* Stop æŒ‰éˆ•ç¸®å° */
  #stopBtn {
    padding: 10px 12px !important;
    font-size: 13px !important;
    border-radius: 12px !important;
  }
}
/* ===== Lock scrolling when recording screen is active ===== */
body.lock-scroll {
  overflow: hidden;
  height: 100vh;
}

/* iOS Safari é˜²æ­¢å½ˆæ€§æ»¾å‹• */
body.lock-scroll {
  position: fixed;
  width: 100%;
}
/* ===== Maintenance Overlay ===== */
#maintenanceOverlay {
  position: fixed;
  inset: 0;
  background: #9B59B6;
  z-index: 9999;
  display: none; /* âœ… é è¨­ä¸é¡¯ç¤º */
  align-items: center;
  justify-content: center;
}


.maintenance-card {
  background: #fff;
  padding: 28px 32px;
  border-radius: 18px;
  text-align: center;
  max-width: 420px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.25);
}

.maintenance-card h1 {
  margin-bottom: 12px;
}

.maintenance-card p {
  margin-top: 8px;
  line-height: 1.6;
}

    
  </style>
</head>

<body>

  <!-- ===== Maintenance Mode ===== -->
<div id="maintenanceOverlay">
  <div class="maintenance-card">
    <h1>ğŸš§ Under Maintenance</h1>
    <p>
      Weâ€™re currently improving the 
      Video Essay/Interview Simulator.<br>
      Please check back shortly.
    </p>
    <p class="muted">
      Thanks for your patience ğŸ™
    </p>
  </div>
</div>


<!-- =======================
     HOME / SETTINGS SCREEN
     ======================= -->
     <!-- ===== Personal Links ===== -->
<div class="personal-links-wrap" id="personalLinks">
  <div class="card personal-links">
    <div class="link-icons">
      <a href="https://www.linkedin.com/in/goldotaku" target="_blank" aria-label="LinkedIn">
        <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/linkedin.svg" alt="LinkedIn">
      </a>

      <a href="https://youtube.com/@goldotaku403" target="_blank" aria-label="YouTube">
        <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/youtube.svg" alt="YouTube">
      </a>

      <a href="https://linktr.ee/goldotaku" target="_blank" aria-label="Linktree">
        <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/linktree.svg" alt="Linktree">
      </a>
    </div>

    <div class="muted creator-text">
      Connect with GoldOtaku
    </div>
  </div>
</div>

<section id="homeScreen">
  <div class="title">
    <h1>Video Essay/Interview Simulator</h1>
    <div class="muted">Start â†’ Countdown â†’ Record â†’ Playback</div>
  </div>

  <div class="card">
    <div class="grid">
      <label>
        Prep time (seconds)
        <input type="number" id="prepTime" value="10" min="0"/>
      </label>

      <label>
        Record time (seconds)
        <input type="number" id="recordTime" value="30" min="1"/>
      </label>

      <label>
        Camera
        <select id="cameraSelect">
          <option value="">(loading devices...)</option>
        </select>
      </label>

      <label>
        Microphone
        <select id="micSelect">
          <option value="">(loading devices...)</option>
        </select>
      </label>
      
      <label>
  Practice Mode
  <select id="modeSelect">
    <option value="sequential_once" selected>Sequential (each question once)</option>
    <option value="random_once">Random (each question once)</option>
    <option value="sequential_marathon">Marathon (sequential loop)</option>
    <option value="random_marathon">Marathon (random loop)</option>
  </select>
</label>

    </div>

    <div style="height:12px"></div>

    <label>
      Question bank (one per line)
      <textarea id="questionBank">Tell us about a time you failed and what you learned.
Why MBA, and why now?
Describe a time you led a team through uncertainty.
What is your short-term goal, and why this school?
Tell us about a time you received tough feedback.</textarea>
    </label>

    <div style="height:14px"></div>

    <div class="row" style="justify-content:space-between; gap:12px; flex-wrap:wrap;">
  <div class="muted" id="homeHint">Tip: allow camera/mic permission when prompted.</div>

  <!-- âœ… ç™»å…¥å€ï¼ˆHomeï¼‰ -->
  <div class="row" id="authHomeArea"></div>

  <div class="row">
    <button class="btn btn-ghost" id="resetSessionBtn" style="display:none;">Reset Session</button>
    <button class="btn btn-primary" id="goStart">Start</button>
  </div>
</div>


  </div>
  <!-- âœ… ç¬¬äºŒå¤§æ¬„ï¼šMy Videosï¼ˆç¨ç«‹ä¸€æ¬„ï¼Œä¸å¡åœ¨ Comments è£¡ï¼‰ -->
<div class="card" id="myVideosCard" style="margin-top:16px; display:none;">
  <div class="row" style="justify-content:space-between; margin-bottom:10px;">
    <h2 style="margin:0;">My Videos</h2>
    <div class="muted" id="myVideosHint">Sign in to see saved videos.</div>
  </div>
  <div id="myVideosList"></div>
</div>

<!-- âœ… ç¬¬ä¸‰å¤§æ¬„ï¼šCommentsï¼ˆåªæ”¾ç•™è¨€ï¼Œä¸æ”¾ My Videosï¼‰ -->
<div class="card" style="margin-top:16px;">
  <h2 style="margin-bottom:10px;">Comments</h2>

  <div class="grid" style="grid-template-columns: 1fr 1fr; align-items:end;">
    <label>
      Name
      <input id="commentName" maxlength="30" placeholder="e.g., Frank"/>
    </label>

    <label>
      Your feedback
      <input id="commentText" maxlength="300" placeholder="What you liked / what to improve..."/>
    </label>
  </div>

  <div style="height:12px"></div>

  <div class="row" style="justify-content:space-between;">
    <div class="muted" id="commentStatus">Be kind and constructive ğŸ™‚</div>
    <button class="btn btn-primary" id="submitComment">Post</button>
  </div>

  <div style="height:14px"></div>
  <div id="commentList"></div>
</div>


</section>


<!-- =======================
     RECORDING SCREEN
     ======================= -->
<section id="recordScreen">
  <video id="cameraBg" autoplay playsinline muted></video>
  <div class="shade"></div>

  <div class="topbar">
    <div class="row">
  <span class="pill" id="statePill">IDLE</span>
  <span class="pill" id="timerPill">00</span>

  <!-- âœ… REC pulsing badge -->
  <span class="pill" id="recBadge">
    <span class="recDot"></span>
    <span class="recText">REC</span>
  </span>

  <!-- âœ… progress bar (recording) -->
  <div class="progressWrap" id="recordProgressWrap" style="display:none;">
    <div class="progressFill" id="recordProgressFill"></div>
  </div>
</div>


    <div class="row panel">
      <label style="font-weight:800; color:#fff;">
        Cam
        <select id="camToggle">
          <option value="on" selected>On</option>
          <option value="off">Off</option>
        </select>
      </label>

      <label style="font-weight:800; color:#fff;">
        Mic
        <select id="micToggle">
          <option value="on" selected>On</option>
          <option value="off">Off</option>
        </select>
      </label>

      <button class="btn btn-ghost" id="backHome">Back</button>
    </div>
  </div>

  <div class="questionBox">
    <div class="questionInner" id="questionText">Question will appear here.</div>
  </div>

  <div id="countdownOverlay">
    <div id="countdownNumber">3</div>
  </div>

  <div class="controls">
    <div class="panel row">
      <div><b>Prep</b>: <span id="prepDisplay">10</span>s</div>
      <div><b>Record</b>: <span id="recordDisplay">30</span>s</div>
    </div>

    <div class="row">
      <button class="btn btn-danger" id="stopBtn" style="display:none;">Stop</button>
    </div>
  </div>

  <!-- Playback overlay -->
  <div id="playbackScreen">
    <div class="playbackCard">
      <div class="row" style="justify-content:space-between; margin-bottom:10px;">
  <div class="row" style="gap:10px; align-items:center;">
    <div style="font-weight:900; font-size:1.1rem;">Playback</div>
    <div class="muted" id="authPlaybackLabel" style="font-weight:800;"></div>
  </div>

  <div class="row">

          <button class="btn btn-ghost" id="retakeBtn">Retake</button>
          <button class="btn btn-primary" id="nextBtn">Next Question</button>
          <button class="btn btn-ghost" id="homeBtn">Home</button>
          <button class="btn btn-ghost" id="saveBtn">Save</button>
          <button class="btn btn-ghost" id="downloadBtn">Download</button>
          <button class="btn btn-ghost" id="closePlayback">Close</button>
        </div>
      </div>

      <video id="playbackVideo" controls playsinline></video>
      <div class="muted" style="margin-top:10px;">
        If playback is blank on some browsers, try Chrome/Edge on desktop.
      </div>
    </div>
  </div>
</section>

<script type="module">
  
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";

  import {
    getFirestore, collection, addDoc, serverTimestamp,
    query, orderBy, onSnapshot, limit, doc, deleteDoc, Timestamp
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  import {
    getAuth,
    GoogleAuthProvider,
    signInWithPopup,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    sendEmailVerification,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

  import {
    getStorage,
    ref as sRef,
    uploadBytesResumable,
    getDownloadURL,
    deleteObject
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAoCsZKLfwPVlQ-4rNukikuAgzR3_oLfmg",
    authDomain: "video-essay-simulator.firebaseapp.com",
    projectId: "video-essay-simulator",
    storageBucket: "video-essay-simulator.firebasestorage.app",
    messagingSenderId: "455293481653",
    appId: "1:455293481653:web:32d2e02c23cf9a68a1c4fc",
    measurementId: "G-N6X8VQ3Z6F"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const storage = getStorage(app);

  /* =========================
     Comments (public)
     ========================= */
  const commentName = document.getElementById("commentName");
  const commentText = document.getElementById("commentText");
  const submitComment = document.getElementById("submitComment");
  const commentList = document.getElementById("commentList");
  const commentStatus = document.getElementById("commentStatus");

  const commentsRef = collection(db, "comments");
  const commentsQ = query(commentsRef, orderBy("createdAt", "desc"), limit(50));

  onSnapshot(commentsQ, (snap) => {
    commentList.innerHTML = "";
    snap.forEach(docu => {
      const d = docu.data();
      const name = (d.name || "Anonymous").replaceAll("<", "&lt;");
      const text = (d.text || "").replaceAll("<", "&lt;");
      const ts = d.createdAt?.toDate ? d.createdAt.toDate() : null;
      const timeStr = ts ? ts.toLocaleString() : "";

      const el = document.createElement("div");
      el.className = "commentItem";
      el.innerHTML = `
        <div class="commentMeta">
          <div>${name}</div>
          <div class="commentTime">${timeStr}</div>
        </div>
        <div class="commentBody">${text}</div>
      `;
      commentList.appendChild(el);
    });
  });

  submitComment?.addEventListener("click", async () => {
    const name = (commentName.value || "").trim().slice(0, 30);
    const text = (commentText.value || "").trim().slice(0, 300);

    if (!text) {
      commentStatus.textContent = "Please write something ğŸ™‚";
      return;
    }

    submitComment.disabled = true;
    submitComment.style.opacity = "0.6";
    commentStatus.textContent = "Posting...";

    try {
      await addDoc(commentsRef, { name: name || "Anonymous", text, createdAt: serverTimestamp() });
      commentText.value = "";
      commentStatus.textContent = "Posted âœ…";
      setTimeout(() => (commentStatus.textContent = "Be kind and constructive ğŸ™‚"), 1200);
    } catch (e) {
      commentStatus.textContent = "Failed to post. Please try again.";
      console.error(e);
    } finally {
      submitComment.disabled = false;
      submitComment.style.opacity = "1";
    }
  });

  /* =========================
     Auth UI (Home + Playback trigger)
     ========================= */
  const authHomeArea = document.getElementById("authHomeArea");
  const myVideosCard = document.getElementById("myVideosCard");
  const myVideosList = document.getElementById("myVideosList");
  const myVideosHint = document.getElementById("myVideosHint");

  const modal = document.createElement("div");
  modal.id = "authModal";
  modal.style.cssText = `
    position:fixed; inset:0; display:none; z-index:99999;
    background:rgba(0,0,0,0.6); align-items:center; justify-content:center;
    padding:16px;
  `;
  modal.innerHTML = `
    <div style="width:min(520px,100%); background:#fff; border-radius:16px; padding:16px;">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
        <div style="font-weight:900; font-size:1.1rem;">Sign in to save videos</div>
        <button id="authModalClose" class="btn btn-ghost" style="background:#eee; color:#111;">Close</button>
      </div>

      <div style="height:10px"></div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button id="googleBtn" class="btn btn-primary">Continue with Google</button>
      </div>

      <div style="height:14px"></div>
      <div style="font-weight:900; margin-bottom:8px;">Email</div>

      <div style="display:grid; grid-template-columns:1fr; gap:10px;">
        <input id="emailInput" placeholder="Email" style="padding:10px 12px; border-radius:10px; border:1px solid #ddd; font-size:1rem;">
        <input id="passwordInput" placeholder="Password" type="password" style="padding:10px 12px; border-radius:10px; border:1px solid #ddd; font-size:1rem;">
      </div>

      <div style="height:12px"></div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button id="emailSignInBtn" class="btn btn-primary">Sign in</button>
        <button id="emailSignUpBtn" class="btn btn-ghost" style="background:#eee; color:#111;">Create account</button>
        <button id="verifyBtn" class="btn btn-ghost" style="background:#eee; color:#111;">Resend verification</button>
      </div>

      <div style="height:10px"></div>
      <div id="authMsg" style="font-weight:700; color:#333;"></div>
      <div style="font-size:0.9rem; opacity:0.8; margin-top:6px;">
        Note: Email users must verify their email before saving videos.
      </div>
    </div>
  `;
  document.body.appendChild(modal);

  const authMsg = modal.querySelector("#authMsg");
  const emailInput = modal.querySelector("#emailInput");
  const passwordInput = modal.querySelector("#passwordInput");

  function openAuthModal(message="") { authMsg.textContent = message || ""; modal.style.display = "flex"; }
  function closeAuthModal() { modal.style.display = "none"; }

  modal.querySelector("#authModalClose").addEventListener("click", closeAuthModal);
  modal.addEventListener("click", (e) => { if (e.target === modal) closeAuthModal(); });

  modal.querySelector("#googleBtn").addEventListener("click", async () => {
    authMsg.textContent = "Signing in...";
    try {
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
      closeAuthModal();
    } catch (e) {
      console.error(e);
      authMsg.textContent = "Google sign-in failed. Please try again.";
    }
  });

  modal.querySelector("#emailSignUpBtn").addEventListener("click", async () => {
    const email = (emailInput.value || "").trim();
    const pass = (passwordInput.value || "").trim();
    if (!email || !pass) return authMsg.textContent = "Please enter email and password.";
    authMsg.textContent = "Creating account...";
    try {
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      await sendEmailVerification(cred.user);
      authMsg.textContent = "Account created âœ… Verification email sent. Please verify then sign in.";
    } catch (e) {
      console.error(e);
      authMsg.textContent = e?.message || "Sign up failed.";
    }
  });

  modal.querySelector("#emailSignInBtn").addEventListener("click", async () => {
    const email = (emailInput.value || "").trim();
    const pass = (passwordInput.value || "").trim();
    if (!email || !pass) return authMsg.textContent = "Please enter email and password.";
    authMsg.textContent = "Signing in...";
    try {
      await signInWithEmailAndPassword(auth, email, pass);
      closeAuthModal();
    } catch (e) {
      console.error(e);
      authMsg.textContent = e?.message || "Sign in failed.";
    }
  });

  modal.querySelector("#verifyBtn").addEventListener("click", async () => {
    const user = auth.currentUser;
    if (!user) return authMsg.textContent = "Please sign in first.";
    try {
      await sendEmailVerification(user);
      authMsg.textContent = "Verification email sent âœ…";
    } catch (e) {
      console.error(e);
      authMsg.textContent = "Failed to send verification email.";
    }
  });

 const authPlaybackLabel = document.getElementById("authPlaybackLabel");

function renderAuthUI(user) {
  if (!authHomeArea) return;

  // ğŸ”’ å¼·åˆ¶è®“ auth å€å¡Šã€Œä¸€å®šçœ‹å¾—åˆ°ã€
  authHomeArea.style.display = "flex";
  authHomeArea.style.alignItems = "center";
  authHomeArea.style.gap = "10px";
  authHomeArea.style.padding = "6px 8px";
  authHomeArea.style.borderRadius = "12px";
  authHomeArea.style.background = "rgba(255,255,255,0.20)";
  authHomeArea.style.border = "1px solid rgba(255,255,255,0.25)";

  if (!user) {
    authHomeArea.innerHTML = `
      <button class="btn btn-primary" data-action="signin">
        Sign in
      </button>
    `;
  } else {
    const email = user.email || "Signed in";
    authHomeArea.innerHTML = `
      <span style="
        background:#fff;
        color:#111;
        padding:6px 10px;
        border-radius:999px;
        font-weight:900;
        max-width:260px;
        overflow:hidden;
        text-overflow:ellipsis;
        white-space:nowrap;
        display:inline-block;
      ">ğŸ‘¤ ${email}</span>

      <button class="btn btn-danger" data-action="signout">
        Sign out
      </button>
    `;
  }

  // ï¼ˆå¯é¸ï¼‰Playback ä¸Šé¡¯ç¤ºä½¿ç”¨è€…
  if (typeof authPlaybackLabel !== "undefined" && authPlaybackLabel) {
    authPlaybackLabel.textContent = user?.email ? `User: ${user.email}` : "";
  }
}



  function userCanSave(user) {
    if (!user) return false;
    return user.emailVerified || user.providerData?.some(p => p.providerId === "google.com");
  }

  function userVideosCol(uid) {
    return collection(db, "users", uid, "videos");
  }

  let unsubscribeMyVideos = null;

  function startMyVideosListener(user) {
    if (unsubscribeMyVideos) unsubscribeMyVideos();
    unsubscribeMyVideos = null;

    if (!myVideosCard || !myVideosList) return;

    if (!user) {
      myVideosCard.style.display = "none";
      myVideosList.innerHTML = "";
      myVideosHint.textContent = "Sign in to see saved videos.";
      return;
    }

    myVideosCard.style.display = "block";

    const qv = query(userVideosCol(user.uid), orderBy("createdAt", "desc"), limit(30));
    unsubscribeMyVideos = onSnapshot(qv, (snap) => {
      myVideosList.innerHTML = "";

      if (snap.empty) {
        myVideosList.innerHTML = `<div class="muted">No saved videos yet.</div>`;
        return;
      }

      snap.forEach((d) => {
        const v = d.data();
        const title = (v.title || "Video").replaceAll("<","&lt;");
        const qTextRaw = v?.meta?.questionText || v?.meta?.qText || "";
        const qText = String(qTextRaw).replaceAll("<","&lt;");

        const created = v.createdAt?.toDate ? v.createdAt.toDate().toLocaleString() : "";
        const expires = v.expiresAt?.toDate ? v.expiresAt.toDate().toLocaleDateString() : "";
        const url = v.downloadURL || "";

        const item = document.createElement("div");
        item.className = "commentItem";
        item.innerHTML = `
          <div class="commentMeta">
            <div style="font-weight:900;">${title}</div>
            <div class="commentTime">${created}</div>
          </div>
          <div class="muted" style="margin-top:6px;">Expires: ${expires}</div>

${qText ? `
  <div class="muted" style="margin-top:8px; line-height:1.5;">
    <b>Question:</b> ${qText}
  </div>
` : ``}

<div class="row" style="margin-top:10px;">
  <a class="btn btn-primary" href="${url}" target="_blank" rel="noopener">Play</a>
  <a class="btn btn-ghost" style="background:#eee; color:#111;" href="${url}" download>Download</a>
  <button class="btn btn-danger" data-del="${d.id}">Delete</button>
</div>

        `;
        item.querySelector(`[data-del="${d.id}"]`)?.addEventListener("click", async () => {
          if (!confirm("Delete this saved video?")) return;
          try {
            if (v.storagePath) await deleteObject(sRef(storage, v.storagePath));
            await deleteDoc(doc(db, "users", user.uid, "videos", d.id));
          } catch (e) {
            console.error(e);
            alert("Delete failed. Please try again.");
          }
        });

        myVideosList.appendChild(item);
      });
    });
  }

  async function saveVideoBlob(blob, meta = {}) {
    const user = auth.currentUser;
    if (!user) throw new Error("NOT_SIGNED_IN");
    if (!userCanSave(user)) throw new Error("EMAIL_NOT_VERIFIED");

    const now = Date.now();
    const expiresAt = Timestamp.fromDate(new Date(now + 14 * 24 * 60 * 60 * 1000));

    const title = meta.title || `Video - ${new Date(now).toLocaleString()}`;
    const fileName = `${now}_${meta.qKey || "q"}_.webm`;
    const storagePath = `videos/${user.uid}/${fileName}`;

    const fileRef = sRef(storage, storagePath);

    await new Promise((resolve, reject) => {
  console.log("[SAVE] blob.size =", blob?.size, "type =", blob?.type);

  const task = uploadBytesResumable(
    fileRef,
    blob,
    { contentType: blob.type || "video/webm" }
  );

  task.on("state_changed",
    (snap) => {
      console.log("[UPLOAD]", {
        state: snap.state,
        bytesTransferred: snap.bytesTransferred,
        totalBytes: snap.totalBytes
      });

      const pct = snap.totalBytes
        ? Math.round((snap.bytesTransferred / snap.totalBytes) * 100)
        : 0;

      const btn = document.getElementById("saveBtn");
      if (btn) btn.textContent = `Saving... ${pct}%`;
    },
    (err) => {
      console.error("[UPLOAD ERROR]", err, "code=", err?.code, "message=", err?.message);
      // æœ‰äº›éŒ¯èª¤æœƒè—åœ¨ serverResponse
      if (err?.serverResponse) console.error("[SERVER RESPONSE]", err.serverResponse);
      reject(err);
    },
    () => {
      console.log("[UPLOAD] completed");
      resolve();
    }
  );
});

    const downloadURL = await getDownloadURL(fileRef);

    await addDoc(userVideosCol(user.uid), {
      title,
      storagePath,
      downloadURL,
      createdAt: serverTimestamp(),
      expiresAt,
      meta: { ...(meta || {}), mime: blob.type || "video/webm", size: blob.size || 0 }
    });

    return downloadURL;
  }

  // expose
  window.getAuthUser = () => auth.currentUser;
  window.openAuthModal = (msg="") => openAuthModal(msg);
  window.saveVideoBlob = (blob, meta={}) => saveVideoBlob(blob, meta);
  window.userCanSave = () => userCanSave(auth.currentUser);
  
// âœ…âœ…âœ… Step 3 æ”¾é€™è£¡ï¼ˆä¸€å®šè¦åœ¨ module è£¡ã€è€Œä¸”åªåŠ ä¸€æ¬¡ï¼‰
const authHomeAreaEl = document.getElementById("authHomeArea");

if (authHomeAreaEl) {
  authHomeAreaEl.addEventListener("click", async (e) => {
    const btn = e.target.closest("button");
    if (!btn) return;

    const action = btn.dataset.action;
    if (!action) return;

    if (action === "signin") {
      openAuthModal();
      return;
    }

    if (action === "signout") {
      try {
        btn.disabled = true;
        btn.style.opacity = "0.6";
        await signOut(auth);
      } catch (err) {
        console.error("Sign out failed:", err);
        alert("Sign out failed. Please try again.");
      } finally {
        btn.disabled = false;
        btn.style.opacity = "1";
      }
    }
  });
} else {
  console.warn("authHomeArea not found. Check <div id='authHomeArea'></div> exists.");
}

 onAuthStateChanged(auth, (user) => {
  renderAuthUI(user);
  startMyVideosListener(user);
});
</script>




<script>
    /* ===== Maintenance Mode Switch ===== */
  const MAINTENANCE_MODE = false; // true / false åˆ‡æ›

  
/* =========================================
   Video Essay Simulator (Camera Background + Record + Playback)
   ========================================= */

const State = { HOME:"HOME", PREP:"PREP", COUNTDOWN:"COUNTDOWN", RECORD:"RECORD", END:"END" };
let state = State.HOME;

let mediaStream = null;
let recorder = null;
let recordedChunks = [];
let recordTimer = null;
let recordStartTs = 0;
let progressRafId = null;
let prepTimer = null;
let hasEverGrantedMedia = false;
let lastRecordedBlob = null;



let prepLeft = 0;
let recordLeft = 0;

let questions = [];
let questionOrder = [];   // å­˜ã€Œé¡Œç›®ç´¢å¼•ã€çš„é †åºï¼ˆå¯éš¨æ©Ÿ/å¯å¾ªç’°ï¼‰
let questionCursor = 0;   // ç›®å‰åšåˆ°ç¬¬å¹¾é¡Œï¼ˆæŒ‡å‘ questionOrderï¼‰
let practiceMode = "sequential_once";



let lastQuestionBankText = "";

// DOM
const downloadBtn = document.getElementById("downloadBtn");
const saveBtn = document.getElementById("saveBtn");

const modeSelect = document.getElementById("modeSelect");

const resetSessionBtn = document.getElementById("resetSessionBtn");
const homeHint = document.getElementById("homeHint");

const homeBtn = document.getElementById("homeBtn");

const recBadge = document.getElementById("recBadge");
const recordProgressWrap = document.getElementById("recordProgressWrap");
const recordProgressFill = document.getElementById("recordProgressFill");

const homeScreen = document.getElementById("homeScreen");
const recordScreen = document.getElementById("recordScreen");

const prepTimeInput = document.getElementById("prepTime");
const recordTimeInput = document.getElementById("recordTime");
const questionBank = document.getElementById("questionBank");

const cameraSelect = document.getElementById("cameraSelect");
const micSelect = document.getElementById("micSelect");

const goStart = document.getElementById("goStart");
const personalLinks = document.getElementById("personalLinks");
const backHome = document.getElementById("backHome");

const cameraBg = document.getElementById("cameraBg");
const questionText = document.getElementById("questionText");

const statePill = document.getElementById("statePill");
const timerPill = document.getElementById("timerPill");

const prepDisplay = document.getElementById("prepDisplay");
const recordDisplay = document.getElementById("recordDisplay");

const camToggle = document.getElementById("camToggle");
const micToggle = document.getElementById("micToggle");

const countdownOverlay = document.getElementById("countdownOverlay");
const countdownNumber = document.getElementById("countdownNumber");

const stopBtn = document.getElementById("stopBtn");

const playbackScreen = document.getElementById("playbackScreen");
const playbackVideo = document.getElementById("playbackVideo");
const closePlayback = document.getElementById("closePlayback");
const retakeBtn = document.getElementById("retakeBtn");
const nextBtn = document.getElementById("nextBtn");

/* ---------- Utilities ---------- */
function lockStartUI() {
  goStart.disabled = true;
  goStart.style.opacity = "0.55";
  goStart.style.cursor = "not-allowed";

  homeHint.textContent = "âœ… Resettingâ€¦ please wait a few seconds.";
  resetSessionBtn.style.display = "inline-block";
}

function unlockStartUI() {
  goStart.disabled = false;
  goStart.style.opacity = "1";
  goStart.style.cursor = "pointer";

  homeHint.textContent = "Tip: allow camera/mic permission when prompted.";
  resetSessionBtn.style.display = "none";
}

function startSmoothRecordProgress(totalSeconds) {
  // å–æ¶ˆèˆŠçš„å‹•ç•«
  if (progressRafId) cancelAnimationFrame(progressRafId);

  recordStartTs = performance.now();
  const totalMs = totalSeconds * 1000;

  const tick = () => {
    if (state !== State.RECORD) return; // ééŒ„å½±ç‹€æ…‹å°±åœæ­¢æ›´æ–°

    const elapsed = performance.now() - recordStartTs;
    const pct = totalMs > 0 ? Math.min(100, (elapsed / totalMs) * 100) : 0;
    recordProgressFill.style.width = pct.toFixed(2) + "%";

    progressRafId = requestAnimationFrame(tick);
  };

  progressRafId = requestAnimationFrame(tick);
}

function stopSmoothRecordProgress() {
  if (progressRafId) cancelAnimationFrame(progressRafId);
  progressRafId = null;
}

function setState(next) {
  state = next;
  statePill.textContent = next;
}

  function lockScroll() {
  document.body.classList.add("lock-scroll");
}

function unlockScroll() {
  document.body.classList.remove("lock-scroll");
}

function pad2(n){ return String(n).padStart(2,"0"); }

function updateTimerPill(sec) {
  timerPill.textContent = `${pad2(sec)}`;
}

function beep(freq=660, ms=160){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.frequency.value = freq;
    gain.gain.value = 0.12;
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.start();
    setTimeout(()=>{ osc.stop(); ctx.close(); }, ms);
  } catch {}
}
function shuffleArray(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function buildQuestionOrder() {
  // å»ºç«‹ 0..n-1 çš„ç´¢å¼•é™£åˆ—
  questionOrder = Array.from({ length: questions.length }, (_, i) => i);

  if (practiceMode === "random_once" || practiceMode === "random_marathon") {
    shuffleArray(questionOrder);
  }

  questionCursor = 0;
}

function getCurrentQuestion() {
  if (!questions.length) return "Tell us about yourself.";
  const idx = questionOrder[questionCursor] ?? 0;
  return questions[idx] ?? "Tell us about yourself.";
}

function advanceQuestion() {
  questionCursor++;

  // ä¸€æ¬¡æ¨¡å¼ï¼šèµ°åˆ°æœ€å¾Œå°±çµæŸ
  if (practiceMode === "sequential_once" || practiceMode === "random_once") {
    return;
  }

  // é¦¬æ‹‰æ¾æ¨¡å¼ï¼šèµ°åˆ°æœ€å¾Œå°±å¾ªç’°
  if (questionCursor >= questionOrder.length) {
    questionCursor = 0;
    // éš¨æ©Ÿé¦¬æ‹‰æ¾ï¼šæ¯ä¸€è¼ªé‡æ–°æ´—ç‰Œï¼ˆç¢ºä¿æ¯é¡Œä»ç„¶æ¯è¼ªåªå‡ºä¸€æ¬¡ï¼‰
    if (practiceMode === "random_marathon") {
      shuffleArray(questionOrder);
    }
  }
}

function hasFinishedAllQuestionsOnce() {
  return questionCursor >= questionOrder.length;
}

  
function speakQuestion(text) {
  return new Promise((resolve) => {
    if (!("speechSynthesis" in window)) return resolve();

    const synth = window.speechSynthesis;

    // âœ… æ¸…æ‰ä¸Šä¸€å¥ + å¼·åˆ¶ resumeï¼ˆChrome å¸¸æœƒåœåœ¨ pausedï¼‰
    synth.cancel();
    synth.resume();

    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = "en-US";
    utter.rate = 0.95;
    utter.pitch = 0.7;
    utter.volume = 1;

    let finished = false;
    let tried = 0;

    const finish = () => {
      if (finished) return;
      finished = true;
      resolve();
    };

    const pickVoice = () => {
      const voices = synth.getVoices() || [];
      const preferred =
        voices.find(v => (v.lang || "").toLowerCase().startsWith("en") &&
          /(male|man|alex|david|daniel|tom|fred|george)/i.test(v.name)
        ) ||
        voices.find(v => (v.lang || "").toLowerCase().startsWith("en"));
      if (preferred) utter.voice = preferred;
    };

    const speakOnce = () => {
      if (finished) return;
      tried++;

      synth.cancel();
      synth.resume();
      pickVoice();

      // âœ… çœŸæ­£é–‹å§‹è¬›æ‰ç®—æˆåŠŸï¼ˆä¸æœƒç«‹åˆ» resolveï¼‰
      utter.onend = finish;
      utter.onerror = () => {
        // âœ… å¤±æ•—å°± retry ä¸€æ¬¡ï¼ˆChrome/Win å¸¸è¦‹ç¬¬ä¸€æ¬¡æœƒ errorï¼‰
        if (tried < 2) {
          setTimeout(speakOnce, 200);
        } else {
          finish(); // çœŸçš„ä¸è¡Œå°±åˆ¥å¡ä½æµç¨‹
        }
      };

      synth.speak(utter);
    };

    // âœ… æœ‰äº›ç€è¦½å™¨ voice list æœƒæ™šåˆ°ï¼šç­‰ä¸€ä¸‹å†è¬›ï¼ˆé¿å…ç©º voice å°è‡´ errorï¼‰
    setTimeout(speakOnce, 120);
  });
}




function parseQuestions() {
  const lines = questionBank.value
    .split("\n")
    .map(s => s.trim())
    .filter(Boolean);

  questions = lines.length
    ? lines
    : ["Tell us about yourself."];
}





/* ---------- Device Handling ---------- */
async function ensurePermissions() {
  // å…ˆæ‹¿ä¸€æ¬¡æ¬Šé™ï¼Œæ‰èƒ½åˆ—å‡º device label
  try {
    const s = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
    s.getTracks().forEach(t=>t.stop());
  } catch (e) {
    // ä½¿ç”¨è€…æ‹’çµ•ä¹Ÿæ²’é—œä¿‚ï¼Œä¹‹å¾Œé‚„æœƒå†è«‹æ±‚ï¼ˆä½†æ²’æœ‰ labelï¼‰
  }
}

async function loadDevices() {
  const devices = await navigator.mediaDevices.enumerateDevices();
  const cams = devices.filter(d=>d.kind === "videoinput");
  const mics = devices.filter(d=>d.kind === "audioinput");

  cameraSelect.innerHTML = cams.map((d,i)=>
    `<option value="${d.deviceId}">${d.label || `Camera ${i+1}`}</option>`
  ).join("") || `<option value="">(no camera found)</option>`;

  micSelect.innerHTML = mics.map((d,i)=>
    `<option value="${d.deviceId}">${d.label || `Microphone ${i+1}`}</option>`
  ).join("") || `<option value="">(no microphone found)</option>`;
}

async function startStream() {
  // âœ… å¦‚æœå·²ç¶“æœ‰ streamï¼Œå°±ç›´æ¥é‡ç”¨ï¼ˆä¸å†è«‹æ±‚æ¬Šé™ï¼‰
  if (mediaStream) {
    mediaStream.getTracks().forEach(t => t.enabled = true);

    const hasVideo = mediaStream.getVideoTracks().length > 0;
    cameraBg.srcObject = hasVideo ? mediaStream : null;

    cameraBg.muted = true;
    await cameraBg.play().catch(()=>{});
    return;
  }

  const camOn = camToggle.value === "on";
  const micOn = micToggle.value === "on";

  const videoConstraint = camOn ? {
    deviceId: cameraSelect.value ? { exact: cameraSelect.value } : undefined
  } : false;

  const audioConstraint = micOn ? {
    deviceId: micSelect.value ? { exact: micSelect.value } : undefined
  } : false;

  if (videoConstraint === false && audioConstraint === false) {
    cameraBg.srcObject = null;
    mediaStream = null;
    return;
  }

  // ğŸ”´ åªæœ‰ç¬¬ä¸€æ¬¡æ‰æœƒè·‘åˆ°é€™è£¡ â†’ åªå•ä¸€æ¬¡æ¬Šé™
  mediaStream = await navigator.mediaDevices.getUserMedia({
    video: videoConstraint,
    audio: audioConstraint
  });

  const hasVideo = mediaStream.getVideoTracks().length > 0;
  cameraBg.srcObject = hasVideo ? mediaStream : null;

  cameraBg.muted = true;
  await cameraBg.play().catch(()=>{});
}


function stopStream() {
  if (!mediaStream) return;
  mediaStream.getTracks().forEach(t=>t.stop());
  mediaStream = null;
}

/* ---------- Recording ---------- */
function pickMimeType() {
  // ç›¡é‡ç”¨ webmï¼ˆChrome/Edge æœ€ç©©ï¼‰
  const candidates = [
    "video/webm;codecs=vp9,opus",
    "video/webm;codecs=vp8,opus",
    "video/webm"
  ];
  for (const t of candidates) {
    if (window.MediaRecorder && MediaRecorder.isTypeSupported(t)) return t;
  }
  return ""; // è®“ç€è¦½å™¨è‡ªå·±æ±ºå®š
}

function startRecording() {
  if (!mediaStream) {
    alert("ç›®å‰ Cam/Mic éƒ½é—œé–‰ï¼Œç„¡æ³•éŒ„å½±éŒ„éŸ³ã€‚è‡³å°‘é–‹å•Ÿå…¶ä¸­ä¸€å€‹ã€‚");
    return;
  }

  recordedChunks = [];
  const mimeType = pickMimeType();
  recorder = new MediaRecorder(mediaStream, mimeType ? { mimeType } : undefined);

  recorder.ondataavailable = (e) => {
    if (e.data && e.data.size > 0) recordedChunks.push(e.data);
  };

  recorder.onstop = () => {
  lastRecordedBlob = new Blob(
    recordedChunks,
    { type: recorder.mimeType || "video/webm" }
  );

  const url = URL.createObjectURL(lastRecordedBlob);
  playbackVideo.src = url;
  showPlayback();
};


  recorder.start(200);
}

function stopRecording() {
  if (recorder && recorder.state !== "inactive") recorder.stop();
}

/* ---------- Screens ---------- */
function showHome() {
  // åˆ‡å›ç•«é¢
  homeScreen.style.display = "flex";
  recordScreen.style.display = "none";
  playbackScreen.style.display = "none";
  stopBtn.style.display = "none";

  // ç‹€æ…‹å› HOME
  setState(State.HOME);

  // åœæ‰æ‰€æœ‰è¨ˆæ™‚èˆ‡éŒ„å½±
  clearTimers();
  stopRecording();
    // âœ… ä¸ stop æ‰ streamï¼Œé¿å…ä¸‹æ¬¡ Start å†æ¬¡è«‹æ±‚æ¬Šé™
  if (mediaStream) {
    mediaStream.getTracks().forEach(t => t.enabled = false);
    
    // âœ… å›é¦–é æ‰å…è¨±ä¸Šä¸‹æ»‘å‹•
  unlockScroll();

  }


  // ===== âœ… é‡é»ï¼šreset éŒ„å½±è¦–è¦ºï¼ˆé¿å…æ®˜ç•™ï¼‰=====
  recBadge.style.display = "none";              // é—œæ‰ REC ğŸ”´
  recordProgressWrap.style.display = "none";    // é—œæ‰é€²åº¦æ¢
  recordProgressFill.style.width = "0%";        // é€²åº¦æ­¸é›¶
  recordScreen.classList.remove("recording");   // ç§»é™¤éŒ„å½±ä¸­çš„èƒŒæ™¯æ•ˆæœ

  // ï¼ˆå¯é¸ä½†å®‰å…¨ï¼‰é‡ç½® timer é¡¯ç¤º
  timerPill.textContent = "00";
    /// âœ… å›é¦–é ï¼šæ°¸é å…è¨± Startï¼ˆé™¤éä½ æƒ³é–ä½ï¼‰
unlockStartUI();

  // âœ… å›é¦–é æ™‚é¡¯ç¤ºå€‹äººé€£çµ
  if (personalLinks) personalLinks.style.display = "flex";

}


function showRecordScreen() {
  homeScreen.style.display = "none";
  recordScreen.style.display = "block";
  playbackScreen.style.display = "none";

    // âœ… Start å¾Œéš±è—å€‹äººé€£çµ
  if (personalLinks) personalLinks.style.display = "none";
  
    // âœ… Start å¾Œç¦æ­¢ä¸Šä¸‹æ»‘å‹•ï¼ˆæ‰‹æ©Ÿ/é›»è…¦éƒ½ä¸€æ¨£ï¼‰
  lockScroll();

}

function showPlayback() {
    stopSmoothRecordProgress();
  playbackScreen.style.display = "block";
  stopBtn.style.display = "none";
  setState(State.END);
  updateTimerPill(0);
  beep(880, 180);
    // âœ… é—œé–‰ REC è¦–è¦º
  recBadge.style.display = "none";
  recordProgressWrap.style.display = "none";
  recordScreen.classList.remove("recording");

}

function hidePlayback() {
  playbackScreen.style.display = "none";
}

/* ---------- Flow: Prep -> Countdown -> Record -> End ---------- */
function clearTimers() {
  if (prepTimer) clearInterval(prepTimer);
  if (recordTimer) clearInterval(recordTimer);
  prepTimer = null;
  recordTimer = null;
}

async function startRun() {
  parseQuestions();

// âœ… å¦‚æœé¡Œåº«æ²’å»ºç«‹é †åºï¼ˆä¿éšªï¼‰ï¼Œå…ˆå»ºç«‹
if (!questionOrder.length) buildQuestionOrder();

// âœ… ä¸€æ¬¡æ¨¡å¼ï¼šåšå®Œå°±å›é¦–é ï¼ˆä¿éšªï¼‰
if ((practiceMode === "sequential_once" || practiceMode === "random_once") && hasFinishedAllQuestionsOnce()) {
  showHome();
  return;
}

  const prepSeconds = parseInt(prepTimeInput.value);
  const recordSeconds = parseInt(recordTimeInput.value);

  if (!Number.isFinite(prepSeconds) || prepSeconds < 0) {
    alert("Prep time è«‹è¼¸å…¥ 0 ä»¥ä¸Šç§’æ•¸");
    return;
  }
  if (!Number.isFinite(recordSeconds) || recordSeconds < 1) {
    alert("Record time è«‹è¼¸å…¥ 1 ä»¥ä¸Šç§’æ•¸");
    return;
  }

  // é€²éŒ„è£½ç•«é¢ï¼ˆç«‹åˆ»åˆ‡æ›ï¼‰
  showRecordScreen();

  // âœ… å…ˆ reset è¦–è¦ºï¼ˆé¿å…æ®˜ç•™ï¼‰
  clearTimers();
  stopSmoothRecordProgress();
  countdownOverlay.style.display = "none";
  recBadge.style.display = "none";
  recordProgressWrap.style.display = "none";
  recordProgressFill.style.width = "0%";
  recordScreen.classList.remove("recording");
  stopBtn.style.display = "none";

  // âœ… ä¸€é€²ç•«é¢å°±æŠŠã€Œæ­£ç¢ºçš„ç§’æ•¸ã€å…ˆé¡¯ç¤ºå‡ºä¾†ï¼ˆå·¦ä¸Š/å·¦ä¸‹ç«‹åˆ»æ­£ç¢ºï¼‰
  prepLeft = prepSeconds;
  recordLeft = recordSeconds;

  prepDisplay.textContent = prepLeft;
  recordDisplay.textContent = recordLeft;

  setState(State.PREP);
  updateTimerPill(prepLeft);

  // âœ… é¡Œç›®ä¹Ÿå…ˆé¡¯ç¤ºå‡ºä¾†ï¼ˆé¿å…ç©ºç™½ï¼‰
  const q = getCurrentQuestion();
  questionText.textContent = getCurrentQuestion();
await speakQuestion(getCurrentQuestion());


  // âœ… å†æ¥ä¸Šæ”åƒé ­/éº¥å…‹é¢¨ï¼ˆé¿å…æ¬Šé™å½ˆçª—æ‰“æ–·èªéŸ³ï¼‰
  try {
    await startStream();
  } catch (e) {
    alert("ç„¡æ³•é–‹å•Ÿæ”åƒé ­/éº¥å…‹é¢¨ã€‚è«‹ç¢ºèªæ¬Šé™æˆ–è£ç½®æ˜¯å¦å¯ç”¨ã€‚");
  }

  // âœ… æœ€å¾Œæ‰é–‹å§‹ Prep å€’æ•¸ï¼ˆæœ€å¾Œä¸‰ç§’å¤§ countdownï¼‰
  prepTimer = setInterval(() => {
    if (state !== State.PREP) return;

    if (prepLeft > 0) {
      prepLeft--;
      prepDisplay.textContent = prepLeft;
      updateTimerPill(prepLeft);

      // æœ€å¾Œ 3 ç§’ï¼šå¤§ countdown
      if (prepLeft <= 3 && prepLeft > 0) {
        countdownOverlay.style.display = "flex";
        countdownNumber.textContent = prepLeft;
        beep(740, 140);
      } else {
        countdownOverlay.style.display = "none";
      }
    } else {
      clearInterval(prepTimer);
      countdownOverlay.style.display = "none";
      beginRecordPhase();
    }
  }, 1000);
}




function beginRecordPhase() {
  setState(State.RECORD);
  stopBtn.style.display = "inline-block";
  updateTimerPill(recordLeft);

  // âœ… é–‹å•Ÿ REC è¦–è¦º
  recBadge.style.display = "inline-flex";
  recordProgressWrap.style.display = "block";
  recordProgressFill.style.width = "0%";
  recordScreen.classList.add("recording");

  const total = recordLeft; // ç¸½éŒ„å½±ç§’æ•¸

  // âœ… é–‹å§‹çµ²æ»‘é€²åº¦æ¢ï¼ˆæ¯å¹€æ›´æ–°ï¼‰
  startSmoothRecordProgress(total);

  // é–‹å§‹éŒ„å½±éŒ„éŸ³
  startRecording();

  // å€’æ•¸ï¼ˆä»ç„¶ 1 ç§’æ›´æ–°ä¸€æ¬¡æ–‡å­—ï¼‰
  recordTimer = setInterval(() => {
    if (state !== State.RECORD) return;

    if (recordLeft > 0) {
      recordLeft--;
      recordDisplay.textContent = recordLeft;
      updateTimerPill(recordLeft);
    } else {
      clearInterval(recordTimer);

      // âœ… æ”¶å°¾ï¼šåœæ­¢çµ²æ»‘é€²åº¦æ¢ï¼Œå›ºå®š 100%
      stopSmoothRecordProgress();
      recordProgressFill.style.width = "100%";

      stopRecording();
      // onstop æœƒé€² playback
    }
  }, 1000);
}



/* ---------- UI Events ---------- */
downloadBtn.addEventListener("click", () => {
  if (!lastRecordedBlob) {
    alert("No video to download.");
    return;
  }

  const url = URL.createObjectURL(lastRecordedBlob);
  const a = document.createElement("a");
  a.href = url;

  // æª”åï¼švideo-essay-q1.webm é€™ç¨®
  a.download = `video-essay-q${questionCursor + 1}.webm`;


  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);

  // æ¸…æ‰æš«æ™‚ URL
  URL.revokeObjectURL(url);
});

  function withTimeout(promise, ms = 25000) {
  return Promise.race([
    promise,
    new Promise((_, reject) =>
      setTimeout(() => reject(new Error("TIMEOUT")), ms)
    )
  ]);
}

  saveBtn.addEventListener("click", async () => {
  try {
    if (!lastRecordedBlob) {
      alert("No video to save yet.");
      return;
    }
    if (lastRecordedBlob.size === 0) {
      alert("Recorded video is empty. Please retake.");
      return;
    }

    const user = window.getAuthUser?.();
    if (!user) {
      window.openAuthModal?.("Please sign in to SAVE your videos.");
      return;
    }

    const canSave = window.userCanSave?.();
    if (!canSave) {
      window.openAuthModal?.("Please verify your email first, then you can save videos.");
      return;
    }

    saveBtn.disabled = true;
    saveBtn.style.opacity = "0.6";
    saveBtn.textContent = "Saving...";

    const title = `Video - ${new Date().toLocaleString()}`;

    // âœ… 25 ç§’è¶…æ™‚ï¼Œé¿å…æ°¸é å¡åœ¨ Saving...
    await window.saveVideoBlob(lastRecordedBlob, {
  title,
  qKey: `q_${questionCursor ?? 0}`,
  questionText: (typeof getCurrentQuestion === "function" ? getCurrentQuestion() : (document.getElementById("questionText")?.textContent || ""))
});
      25000
    );

    saveBtn.textContent = "Saved âœ…";
    setTimeout(() => (saveBtn.textContent = "SAVE"), 1200);

  } catch (e) {
    console.error(e);

    if (String(e?.message || "").includes("TIMEOUT")) {
      alert("Save timed out. Usually caused by Storage rules/bucket/CORS or network. Please try again.");
    } else {
      alert("Save failed. Please try again.");
    }

    saveBtn.textContent = "SAVE";
  } finally {
    saveBtn.disabled = false;
    saveBtn.style.opacity = "1";
  }
});



resetSessionBtn.addEventListener("click", () => {
  // é‡æ–°é–‹å§‹ï¼šé‡å»ºé †åº + æŒ‡æ¨™æ­¸é›¶
  parseQuestions();
  buildQuestionOrder();
  unlockStartUI();
});


homeBtn.addEventListener("click", () => {
  hidePlayback();
  showHome();
});

goStart.addEventListener("click", async () => {
  // è®€å–æ¨¡å¼
  practiceMode = modeSelect?.value || "sequential_once";

  // è§£æé¡Œåº« + å»ºç«‹é †åºï¼ˆåªåšä¸€æ¬¡ï¼‰
  parseQuestions();
  buildQuestionOrder();

  // é–‹å§‹ç¬¬ä¸€é¡Œ
  await startRun();
});



backHome.addEventListener("click", () => showHome());


stopBtn.addEventListener("click", () => {
  clearTimers();
  stopRecording();
});

closePlayback.addEventListener("click", () => hidePlayback());

retakeBtn.addEventListener("click", async () => {
  hidePlayback();
  // åŒä¸€é¡Œé‡éŒ„ï¼šé‡æ–°è·‘ä¸€æ¬¡ï¼ˆä¸æ›é¡Œï¼‰
  await startRun();
});

nextBtn.addEventListener("click", async () => {
  hidePlayback();

  // å‰é€²åˆ°ä¸‹ä¸€é¡Œ
  advanceQuestion();

  // âœ… ä¸€æ¬¡æ¨¡å¼ï¼šå…¨éƒ¨åšå®Œ â†’ å›é¦–é 
  if ((practiceMode === "sequential_once" || practiceMode === "random_once") && hasFinishedAllQuestionsOnce()) {
    showHome();
    return;
  }

  // å¦å‰‡ç¹¼çºŒè·‘ä¸‹ä¸€é¡Œ
  await startRun();
});







// åœ¨éŒ„è£½ç•«é¢åˆ‡æ› Cam/Micï¼šé‡æ–°æ‹‰ streamï¼ˆä¸å½±éŸ¿ç›®å‰å·²é–‹å§‹éŒ„çš„é€™æ¬¡ï¼›å»ºè­°åœ¨éŒ„å‰åˆ‡ï¼‰
camToggle.addEventListener("change", async () => {
  if (recordScreen.style.display !== "block") return;
  // è‹¥æ­£åœ¨éŒ„å½±ï¼šå¼·çƒˆå»ºè­°ä¸è¦ä¸­é€”æ›ï¼ˆä¸åŒç€è¦½å™¨è¡Œç‚ºä¸ä¸€è‡´ï¼‰
  if (state === State.RECORD) return;
  try { await startStream(); } catch {}
});

micToggle.addEventListener("change", async () => {
  if (recordScreen.style.display !== "block") return;
  if (state === State.RECORD) return;
  try { await startStream(); } catch {}
});

// é€²å…¥é é¢å…ˆè¦æ¬Šé™ï¼ˆå¯è®“è£ç½®åˆ—è¡¨é¡¯ç¤ºåç¨±ï¼‰
(async function init() {
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´æ”åƒé ­/éº¥å…‹é¢¨ APIã€‚è«‹ç”¨æœ€æ–°ç‰ˆ Chrome/Edgeã€‚");
    return;
  }
  await ensurePermissions();
  await loadDevices();

  // è£ç½®è®Šå‹•ï¼ˆæ’æ‹”ï¼‰æ›´æ–°
  navigator.mediaDevices.addEventListener?.("devicechange", async () => {
    await loadDevices();
  });
})();

// åˆå§‹
showHome();
  
/* ===== Maintenance Mode Logic ===== */
const overlay = document.getElementById("maintenanceOverlay");
if (overlay) {
  overlay.style.display = MAINTENANCE_MODE ? "flex" : "none";
}



</script>
</body>
</html>

































