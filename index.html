<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Video Essay Simulator</title>
  <style>
    * { box-sizing: border-box; margin:0; padding:0; }
    body { font-family: "Microsoft JhengHei", system-ui, sans-serif; background:#9B59B6; color:#111; }

    /* ===== Shared ===== */
    .btn {
      border: none; border-radius: 10px;
      padding: 12px 14px; font-weight: 700;
      cursor: pointer;
    }
    .btn-primary { background:#2d1b69; color:#fff; }
    .btn-ghost { background:rgba(255,255,255,0.15); color:#fff; border:1px solid rgba(255,255,255,0.25); }
    .btn-danger { background:#b91c1c; color:#fff; }
    .pill { padding:8px 10px; border-radius:999px; background:rgba(0,0,0,0.35); color:#fff; font-weight:700; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .muted { opacity:0.85; }

    /* ===== Home Screen ===== */
    #homeScreen {
      min-height: 100vh;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      align-items: center;
    }
    .title { text-align:center; color:#fff; }
    .title h1 { font-size: 2.2rem; }
    .card {
      width: min(960px, 100%);
      background: #fff;
      border-radius: 14px;
      padding: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
    }
    .grid {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 720px){ .grid { grid-template-columns: 1fr; } }

    label { display:flex; flex-direction:column; gap:6px; font-weight:700; }
    input, select, textarea {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ddd;
      font-size: 1rem;
    }
    textarea { min-height: 84px; resize: vertical; }

    /* ===== Record Screen ===== */
    #recordScreen {
      display:none;
      position: relative;
      min-height: 100vh;
      overflow: hidden;
      background:#000;
    }

    /* Camera background video */
    #cameraBg {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: contrast(1.05) saturate(1.05);
      /* âœ… é¡åƒï¼ˆå·¦å³ç›¸åï¼‰ */
  transform: scaleX(-1) scale(1.02);
    }

    /* Dark overlay for readability */
    .shade {
      position:absolute; inset:0;
      background: linear-gradient(
        to bottom,
        rgba(0,0,0,0.55),
        rgba(0,0,0,0.35),
        rgba(0,0,0,0.6)
      );
      pointer-events:none;
    }

    /* Top bar */
    .topbar {
      position:absolute; top:14px; left:14px; right:14px;
      display:flex; justify-content:space-between; align-items:center;
      gap: 10px;
      z-index: 5;
    }

    /* Bottom controls */
    .controls {
      position:absolute; left:14px; right:14px; bottom:14px;
      display:flex; justify-content:space-between; align-items:center;
      gap: 10px; flex-wrap:wrap;
      z-index: 5;
    }

    .panel {
      background: rgba(0,0,0,0.40);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 14px;
      padding: 12px;
      color:#fff;
      backdrop-filter: blur(8px);
    }

    /* Big countdown */
    #countdownOverlay {
      position:absolute; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 6;
    }
    #countdownNumber {
      font-size: min(18vw, 140px);
      color:#fff;
      font-weight: 900;
      text-shadow: 0 10px 40px rgba(0,0,0,0.6);
      letter-spacing: 2px;
    }

    /* Question overlay */
    .questionBox {
      position:absolute;
      left: 14px;
      right: 14px;
      top: 76px;
      z-index: 5;
      display:flex;
      justify-content:center;
    }
    .questionInner {
      width: min(960px, 100%);
      text-align: center;
      font-size: clamp(18px, 2.2vw, 26px);
      font-weight: 800;
      color:#fff;
      padding: 12px 14px;
      border-radius: 14px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.15);
      backdrop-filter: blur(8px);
    }

    /* Playback modal-like screen */
    #playbackScreen {
      display:none;
      position:absolute;
      inset:0;
      z-index: 10;
      background: rgba(0,0,0,0.75);
      padding: 18px;
    }
    .playbackCard {
      width: min(980px, 100%);
      margin: 0 auto;
      background: rgba(0,0,0,0.50);
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 16px;
      padding: 14px;
      color:#fff;
      backdrop-filter: blur(10px);
    }
    #playbackVideo {
      width: 100%;
      max-height: 65vh;
      border-radius: 14px;
      background:#000;
    }
    /* ===== REC pulsing + progress ===== */
#recBadge {
  display: none;
  align-items: center;
  gap: 10px;
}

.recDot {
  width: 12px;
  height: 12px;
  border-radius: 999px;
  background: #ff2d2d;
  box-shadow: 0 0 0 rgba(255,45,45,0.6);
  animation: recPulse 1.1s infinite;
}

@keyframes recPulse {
  0%   { transform: scale(1);   box-shadow: 0 0 0 0 rgba(255,45,45,0.65); opacity: 1; }
  70%  { transform: scale(1.18); box-shadow: 0 0 0 12px rgba(255,45,45,0); opacity: 0.95; }
  100% { transform: scale(1);   box-shadow: 0 0 0 0 rgba(255,45,45,0); opacity: 1; }
}

.recText {
  font-weight: 900;
  letter-spacing: 1px;
}

/* progress bar */
.progressWrap {
  width: min(420px, 60vw);
  height: 10px;
  border-radius: 999px;
  background: rgba(255,255,255,0.18);
  overflow: hidden;
  border: 1px solid rgba(255,255,255,0.18);
}

.progressFill {
  height: 100%;
  width: 0%;
  background: rgba(255,255,255,0.92);
  border-radius: 999px;
  transition: width 0.2s linear;
}

/* "recording vibe" on camera bg */
#recordScreen.recording #cameraBg {
  filter: contrast(1.15) saturate(1.18);
}

/* subtle vignette while recording */
#recordScreen.recording .shade {
  background: radial-gradient(circle at center,
    rgba(0,0,0,0.35),
    rgba(0,0,0,0.55)
  );
}
.commentItem{
  border:1px solid #eee;
  border-radius:12px;
  padding:12px;
  margin-bottom:10px;
}
.commentMeta{
  display:flex;
  justify-content:space-between;
  gap:10px;
  font-weight:900;
}
.commentTime{
  font-weight:700;
  opacity:0.65;
  font-size:0.9rem;
}
.commentBody{
  margin-top:6px;
  line-height:1.6;
  white-space:pre-wrap;
}

/* ===== Personal Links ===== */
.personal-links {
  text-align: center;
}

.link-icons {
  display: flex;
  justify-content: center;
  gap: 26px;
}

.link-icons a {
  width: 42px;
  height: 42px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  background: #f3f3f3;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.link-icons a:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.18);
}

.link-icons img {
  width: 22px;
  height: 22px;
  filter: invert(0.15);
}
/* ===== Personal Links (Centered & Compact) ===== */
.personal-links-wrap {
  display: flex;
  justify-content: center;
  margin-top: 16px;
}

.personal-links {
  width: fit-content;          /* âœ… é—œéµï¼šä¸è¦æ’æ»¿ */
  padding: 14px 22px;
  text-align: center;
}

.link-icons {
  display: flex;
  justify-content: center;
  gap: 20px;                   /* ç¨å¾®ç¸®çŸ­ */
}

.link-icons a {
  width: 38px;                 /* ç¸®å°ä¸€é» */
  height: 38px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  background: #f3f3f3;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.link-icons a:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 14px rgba(0,0,0,0.18);
}

.link-icons img {
  width: 20px;
  height: 20px;
  filter: invert(0.15);
}

.creator-text {
  margin-top: 8px;
  font-size: 0.9rem;           /* å­—ä¹Ÿç¸®ä¸€é» */
}
    
/* ===== Mobile text overflow fix ===== */
@media (max-width: 480px) {
  .creator-text,
  .playbackCard,
  .panel,
  .questionInner {
    word-break: break-word;
    overflow-wrap: anywhere;
  }
}

    /* ===== Fix comment form overflow on mobile ===== */
@media (max-width: 600px) {
  /* ä½ ç•™è¨€è¡¨å–®ç”¨ .grid å…©æ¬„æ’ç‰ˆï¼Œæ‰‹æ©Ÿæ”¹æˆå–®æ¬„ */
  #homeScreen .grid {
    grid-template-columns: 1fr !important;
  }

  /* è®“è¼¸å…¥æ¡†ä¸æœƒæ’å‡ºå®¹å™¨ */
  #commentName,
  #commentText {
    width: 100% !important;
    max-width: 100% !important;
  }

  /* é˜²æ­¢å¡ç‰‡å…§å®¹è¢«æ’çˆ†ï¼ˆä¿éšªï¼‰ */
  #homeScreen .card {
    overflow: hidden;
  }
}
/* ===== Mobile: keep question centered and not overlapping UI ===== */
@media (max-width: 600px) {

  /* é¡Œç›®æ•´å€‹å€å¡Šå¾€ä¸‹ï¼Œé¿é–‹ topbar */
  .questionBox {
    top: 150px !important;      /* ä½ å¯å¾®èª¿ï¼š80~110 éƒ½è¡Œ */
    left: 10px !important;
    right: 10px !important;
  }

  /* é¡Œç›®æœ¬é«”ï¼šç½®ä¸­ã€å¯æ›è¡Œã€ä¸æœƒè¶…å‡º */
  .questionInner {
    width: 100% !important;
    max-width: 100% !important;
    padding: 10px 12px !important;
    font-size: 16px !important;        /* æ‰‹æ©Ÿå­—ç¨å¾®å°ä¸€é» */
    line-height: 1.35 !important;
    text-align: center !important;

    /* âœ… é—œéµï¼šè‹±æ–‡é•·å¥è¦èƒ½æ–·è¡Œ */
    overflow-wrap: anywhere !important;
    word-break: break-word !important;
  }

  /* è®“åº•éƒ¨ controls ç•™å‡ºç©ºé–“ï¼Œé¿å…é¡Œç›®æ’åˆ° Prep/Record */
  .controls {
    bottom: 12px !important;
  }
}
/* ===== Record screen: mobile layout (everything fits in one viewport) ===== */
@media (max-width: 600px) {
  /* ä¸Šæ–¹æ¢æ›´ç·Šæ¹Š */
  .topbar {
    top: 10px !important;
    left: 10px !important;
    right: 10px !important;
    gap: 8px !important;
    align-items: flex-start !important;
  }

  /* è®“ topbar å·¦å³å…©å¡Šåœ¨å°è¢å¹•èƒ½æ”¾å¾—ä¸‹ï¼šå¿…è¦æ™‚æ›è¡Œ */
  .topbar .row {
    gap: 8px !important;
    flex-wrap: wrap !important;
  }

  /* å³ä¸Šæ§åˆ¶é¢æ¿ç¸®å° */
  .topbar .panel {
    padding: 8px 10px !important;
    border-radius: 12px !important;
  }

  .topbar .panel label {
    font-size: 12px !important;
    gap: 4px !important;
  }

  .topbar .panel select {
    padding: 6px 8px !important;
    border-radius: 10px !important;
    font-size: 12px !important;
  }

  .topbar .panel .btn {
    padding: 8px 10px !important;
    border-radius: 10px !important;
    font-size: 12px !important;
  }

  /* å·¦ä¸Š pill ç¸®å° */
  .pill {
    padding: 6px 8px !important;
    font-size: 12px !important;
  }

  /* é€²åº¦æ¢ç¸®çŸ­ï¼Œé¿å…æ“ çˆ† */
  .progressWrap {
    width: 45vw !important;
    height: 8px !important;
  }

  /* é¡Œç›®å€å¾€ä¸Šï¼Œä½†ä¸è“‹åˆ° topbarï¼›å­—ç•¥ç¸®ã€å¯æ–·è¡Œ */
  .questionBox {
    top: 86px !important;     /* ä½ è‹¥è¦ºå¾—å¤ªæ“ ï¼Œå¯æ”¹ 92~105 */
    left: 10px !important;
    right: 10px !important;
  }

  .questionInner {
    padding: 10px 12px !important;
    font-size: 16px !important;
    line-height: 1.35 !important;
    overflow-wrap: anywhere !important;
    word-break: break-word !important;
    text-align: center !important;
  }

  /* ä¸‹æ–¹æ§åˆ¶åˆ—ç¸®å°ï¼Œç¢ºä¿åŒç•«é¢çœ‹å¾—åˆ° */
  .controls {
    left: 10px !important;
    right: 10px !important;
    bottom: 10px !important;
    gap: 8px !important;
  }

  .controls .panel {
    padding: 8px 10px !important;
    border-radius: 12px !important;
    font-size: 12px !important;
  }

  /* Stop æŒ‰éˆ•ç¸®å° */
  #stopBtn {
    padding: 10px 12px !important;
    font-size: 13px !important;
    border-radius: 12px !important;
  }
}
/* ===== Lock scrolling when recording screen is active ===== */
body.lock-scroll {
  overflow: hidden;
  height: 100vh;
}

/* iOS Safari é˜²æ­¢å½ˆæ€§æ»¾å‹• */
body.lock-scroll {
  position: fixed;
  width: 100%;
}

    
  </style>
</head>

<body>

<!-- =======================
     HOME / SETTINGS SCREEN
     ======================= -->
     <!-- ===== Personal Links ===== -->
<div class="personal-links-wrap" id="personalLinks">
  <div class="card personal-links">
    <div class="link-icons">
      <a href="https://www.linkedin.com/in/goldotaku" target="_blank" aria-label="LinkedIn">
        <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/linkedin.svg" alt="LinkedIn">
      </a>

      <a href="https://youtube.com/@goldotaku403" target="_blank" aria-label="YouTube">
        <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/youtube.svg" alt="YouTube">
      </a>

      <a href="https://linktr.ee/goldotaku" target="_blank" aria-label="Linktree">
        <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/linktree.svg" alt="Linktree">
      </a>
    </div>

    <div class="muted creator-text">
      Connect with GoldOtaku
    </div>
  </div>
</div>

<section id="homeScreen">
  <div class="title">
    <h1>Video Essay Simulator</h1>
    <div class="muted">Start â†’ Countdown â†’ Record â†’ Playback</div>
  </div>

  <div class="card">
    <div class="grid">
      <label>
        Prep time (seconds)
        <input type="number" id="prepTime" value="10" min="0"/>
      </label>

      <label>
        Record time (seconds)
        <input type="number" id="recordTime" value="30" min="1"/>
      </label>

      <label>
        Camera
        <select id="cameraSelect">
          <option value="">(loading devices...)</option>
        </select>
      </label>

      <label>
        Microphone
        <select id="micSelect">
          <option value="">(loading devices...)</option>
        </select>
      </label>
    </div>

    <div style="height:12px"></div>

    <label>
      Question bank (one per line)
      <textarea id="questionBank">Tell us about a time you failed and what you learned.
Why MBA, and why now?
Describe a time you led a team through uncertainty.
What is your short-term goal, and why this school?
Tell us about a time you received tough feedback.</textarea>
    </label>

    <div style="height:14px"></div>

    <div class="row" style="justify-content:space-between;">
  <div class="muted" id="homeHint">Tip: allow camera/mic permission when prompted.</div>

  <div class="row">
    <button class="btn btn-ghost" id="resetSessionBtn" style="display:none;">Reset Session</button>
    <button class="btn btn-primary" id="goStart">Start</button>
  </div>
</div>

  </div>
  <div class="card" style="margin-top:16px;">
  <h2 style="margin-bottom:10px;">Comments</h2>

  <div class="grid" style="grid-template-columns: 1fr 1fr; align-items:end;">
    <label>
      Name
      <input id="commentName" maxlength="30" placeholder="e.g., Frank"/>
    </label>

    <label>
      Your feedback
      <input id="commentText" maxlength="300" placeholder="What you liked / what to improve..."/>
    </label>
  </div>

  <div style="height:12px"></div>

  <div class="row" style="justify-content:space-between;">
    <div class="muted" id="commentStatus">Be kind and constructive ğŸ™‚</div>
    <button class="btn btn-primary" id="submitComment">Post</button>
  </div>

  <div style="height:14px"></div>
  <div id="commentList"></div>
</div>

</section>


<!-- =======================
     RECORDING SCREEN
     ======================= -->
<section id="recordScreen">
  <video id="cameraBg" autoplay playsinline muted></video>
  <div class="shade"></div>

  <div class="topbar">
    <div class="row">
  <span class="pill" id="statePill">IDLE</span>
  <span class="pill" id="timerPill">00</span>

  <!-- âœ… REC pulsing badge -->
  <span class="pill" id="recBadge">
    <span class="recDot"></span>
    <span class="recText">REC</span>
  </span>

  <!-- âœ… progress bar (recording) -->
  <div class="progressWrap" id="recordProgressWrap" style="display:none;">
    <div class="progressFill" id="recordProgressFill"></div>
  </div>
</div>


    <div class="row panel">
      <label style="font-weight:800; color:#fff;">
        Cam
        <select id="camToggle">
          <option value="on" selected>On</option>
          <option value="off">Off</option>
        </select>
      </label>

      <label style="font-weight:800; color:#fff;">
        Mic
        <select id="micToggle">
          <option value="on" selected>On</option>
          <option value="off">Off</option>
        </select>
      </label>

      <button class="btn btn-ghost" id="backHome">Back</button>
    </div>
  </div>

  <div class="questionBox">
    <div class="questionInner" id="questionText">Question will appear here.</div>
  </div>

  <div id="countdownOverlay">
    <div id="countdownNumber">3</div>
  </div>

  <div class="controls">
    <div class="panel row">
      <div><b>Prep</b>: <span id="prepDisplay">10</span>s</div>
      <div><b>Record</b>: <span id="recordDisplay">30</span>s</div>
    </div>

    <div class="row">
      <button class="btn btn-danger" id="stopBtn" style="display:none;">Stop</button>
    </div>
  </div>

  <!-- Playback overlay -->
  <div id="playbackScreen">
    <div class="playbackCard">
      <div class="row" style="justify-content:space-between; margin-bottom:10px;">
        <div style="font-weight:900; font-size:1.1rem;">Playback</div>
        <div class="row">
          <button class="btn btn-ghost" id="retakeBtn">Retake</button>
          <button class="btn btn-primary" id="nextBtn">Next Question</button>
          <button class="btn btn-ghost" id="homeBtn">Home</button>
          <button class="btn btn-ghost" id="downloadBtn">DOWNLOAD</button>
          <button class="btn btn-ghost" id="closePlayback">Close</button>
        </div>
      </div>

      <video id="playbackVideo" controls playsinline></video>
      <div class="muted" style="margin-top:10px;">
        If playback is blank on some browsers, try Chrome/Edge on desktop.
      </div>
    </div>
  </div>
</section>

<script type="module">
  // Firebase SDK (modular)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import {
    getFirestore, collection, addDoc, serverTimestamp,
    query, orderBy, onSnapshot, limit
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  // âœ… 1) ä½ è¦æŠŠé€™è£¡æ›æˆä½ è‡ªå·±çš„ Firebase configï¼ˆå¾ Firebase Console è¤‡è£½ï¼‰
  const firebaseConfig = {
  apiKey: "AIzaSyAoCsZKLfwPVlQ-4rNukikuAgzR3_oLfmg",
  authDomain: "video-essay-simulator.firebaseapp.com",
  projectId: "video-essay-simulator",
  storageBucket: "video-essay-simulator.firebasestorage.app",
  messagingSenderId: "455293481653",
  appId: "1:455293481653:web:32d2e02c23cf9a68a1c4fc",
  measurementId: "G-N6X8VQ3Z6F"
    
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // DOM
  const commentName = document.getElementById("commentName");
  const commentText = document.getElementById("commentText");
  const submitComment = document.getElementById("submitComment");
  const commentList = document.getElementById("commentList");
  const commentStatus = document.getElementById("commentStatus");

  // è®€å–ç•™è¨€ï¼ˆæœ€æ–° 50 å‰‡ï¼‰
  const commentsRef = collection(db, "comments");
  const q = query(commentsRef, orderBy("createdAt", "desc"), limit(50));

  onSnapshot(q, (snap) => {
    commentList.innerHTML = "";
    snap.forEach(doc => {
      const d = doc.data();
      const name = (d.name || "Anonymous").replaceAll("<", "&lt;");
      const text = (d.text || "").replaceAll("<", "&lt;");
      const ts = d.createdAt?.toDate ? d.createdAt.toDate() : null;
      const timeStr = ts ? ts.toLocaleString() : "";

      const el = document.createElement("div");
      el.className = "commentItem";
      el.innerHTML = `
        <div class="commentMeta">
          <div>${name}</div>
          <div class="commentTime">${timeStr}</div>
        </div>
        <div class="commentBody">${text}</div>
      `;
      commentList.appendChild(el);
    });
  });

  // ç™¼ä½ˆç•™è¨€
  submitComment.addEventListener("click", async () => {
    const name = (commentName.value || "").trim().slice(0, 30);
    const text = (commentText.value || "").trim().slice(0, 300);

    if (!text) {
      commentStatus.textContent = "Please write something ğŸ™‚";
      return;
    }

    submitComment.disabled = true;
    submitComment.style.opacity = "0.6";
    commentStatus.textContent = "Posting...";

    try {
      await addDoc(commentsRef, {
        name: name || "Anonymous",
        text,
        createdAt: serverTimestamp()
      });

      commentText.value = "";
      commentStatus.textContent = "Posted âœ…";
      setTimeout(() => (commentStatus.textContent = "Be kind and constructive ğŸ™‚"), 1200);
    } catch (e) {
      commentStatus.textContent = "Failed to post. Please try again.";
      console.error(e);
    } finally {
      submitComment.disabled = false;
      submitComment.style.opacity = "1";
    }
  });
</script>


<script>
/* =========================================
   Video Essay Simulator (Camera Background + Record + Playback)
   ========================================= */

const State = { HOME:"HOME", PREP:"PREP", COUNTDOWN:"COUNTDOWN", RECORD:"RECORD", END:"END" };
let state = State.HOME;

let mediaStream = null;
let recorder = null;
let recordedChunks = [];
let recordTimer = null;
let recordStartTs = 0;
let progressRafId = null;
let prepTimer = null;
let hasEverGrantedMedia = false;
let lastRecordedBlob = null;



let prepLeft = 0;
let recordLeft = 0;

let questions = [];
let qIndex = 0;
let sessionCompleted = false;


let lastQuestionBankText = "";

// DOM
const downloadBtn = document.getElementById("downloadBtn");

const resetSessionBtn = document.getElementById("resetSessionBtn");
const homeHint = document.getElementById("homeHint");

const homeBtn = document.getElementById("homeBtn");

const recBadge = document.getElementById("recBadge");
const recordProgressWrap = document.getElementById("recordProgressWrap");
const recordProgressFill = document.getElementById("recordProgressFill");

const homeScreen = document.getElementById("homeScreen");
const recordScreen = document.getElementById("recordScreen");

const prepTimeInput = document.getElementById("prepTime");
const recordTimeInput = document.getElementById("recordTime");
const questionBank = document.getElementById("questionBank");

const cameraSelect = document.getElementById("cameraSelect");
const micSelect = document.getElementById("micSelect");

const goStart = document.getElementById("goStart");
const personalLinks = document.getElementById("personalLinks");
const backHome = document.getElementById("backHome");

const cameraBg = document.getElementById("cameraBg");
const questionText = document.getElementById("questionText");

const statePill = document.getElementById("statePill");
const timerPill = document.getElementById("timerPill");

const prepDisplay = document.getElementById("prepDisplay");
const recordDisplay = document.getElementById("recordDisplay");

const camToggle = document.getElementById("camToggle");
const micToggle = document.getElementById("micToggle");

const countdownOverlay = document.getElementById("countdownOverlay");
const countdownNumber = document.getElementById("countdownNumber");

const stopBtn = document.getElementById("stopBtn");

const playbackScreen = document.getElementById("playbackScreen");
const playbackVideo = document.getElementById("playbackVideo");
const closePlayback = document.getElementById("closePlayback");
const retakeBtn = document.getElementById("retakeBtn");
const nextBtn = document.getElementById("nextBtn");

/* ---------- Utilities ---------- */
function lockStartUI() {
  goStart.disabled = true;
  goStart.style.opacity = "0.55";
  goStart.style.cursor = "not-allowed";

  homeHint.textContent = "âœ… Resettingâ€¦ please wait a few seconds.";
  resetSessionBtn.style.display = "inline-block";
}

function unlockStartUI() {
  goStart.disabled = false;
  goStart.style.opacity = "1";
  goStart.style.cursor = "pointer";

  homeHint.textContent = "Tip: allow camera/mic permission when prompted.";
  resetSessionBtn.style.display = "none";
}

function startSmoothRecordProgress(totalSeconds) {
  // å–æ¶ˆèˆŠçš„å‹•ç•«
  if (progressRafId) cancelAnimationFrame(progressRafId);

  recordStartTs = performance.now();
  const totalMs = totalSeconds * 1000;

  const tick = () => {
    if (state !== State.RECORD) return; // ééŒ„å½±ç‹€æ…‹å°±åœæ­¢æ›´æ–°

    const elapsed = performance.now() - recordStartTs;
    const pct = totalMs > 0 ? Math.min(100, (elapsed / totalMs) * 100) : 0;
    recordProgressFill.style.width = pct.toFixed(2) + "%";

    progressRafId = requestAnimationFrame(tick);
  };

  progressRafId = requestAnimationFrame(tick);
}

function stopSmoothRecordProgress() {
  if (progressRafId) cancelAnimationFrame(progressRafId);
  progressRafId = null;
}

function setState(next) {
  state = next;
  statePill.textContent = next;
}

  function lockScroll() {
  document.body.classList.add("lock-scroll");
}

function unlockScroll() {
  document.body.classList.remove("lock-scroll");
}

function pad2(n){ return String(n).padStart(2,"0"); }

function updateTimerPill(sec) {
  timerPill.textContent = `${pad2(sec)}`;
}

function beep(freq=660, ms=160){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.frequency.value = freq;
    gain.gain.value = 0.12;
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.start();
    setTimeout(()=>{ osc.stop(); ctx.close(); }, ms);
  } catch {}
}

function speakQuestion(text) {
  return new Promise((resolve) => {
    if (!("speechSynthesis" in window)) return resolve();

    const synth = window.speechSynthesis;

    // âœ… æ¸…æ‰ä¸Šä¸€å¥ + å¼·åˆ¶ resumeï¼ˆChrome å¸¸æœƒåœåœ¨ pausedï¼‰
    synth.cancel();
    synth.resume();

    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = "en-US";
    utter.rate = 0.95;
    utter.pitch = 0.7;
    utter.volume = 1;

    let finished = false;
    let tried = 0;

    const finish = () => {
      if (finished) return;
      finished = true;
      resolve();
    };

    const pickVoice = () => {
      const voices = synth.getVoices() || [];
      const preferred =
        voices.find(v => (v.lang || "").toLowerCase().startsWith("en") &&
          /(male|man|alex|david|daniel|tom|fred|george)/i.test(v.name)
        ) ||
        voices.find(v => (v.lang || "").toLowerCase().startsWith("en"));
      if (preferred) utter.voice = preferred;
    };

    const speakOnce = () => {
      if (finished) return;
      tried++;

      synth.cancel();
      synth.resume();
      pickVoice();

      // âœ… çœŸæ­£é–‹å§‹è¬›æ‰ç®—æˆåŠŸï¼ˆä¸æœƒç«‹åˆ» resolveï¼‰
      utter.onend = finish;
      utter.onerror = () => {
        // âœ… å¤±æ•—å°± retry ä¸€æ¬¡ï¼ˆChrome/Win å¸¸è¦‹ç¬¬ä¸€æ¬¡æœƒ errorï¼‰
        if (tried < 2) {
          setTimeout(speakOnce, 200);
        } else {
          finish(); // çœŸçš„ä¸è¡Œå°±åˆ¥å¡ä½æµç¨‹
        }
      };

      synth.speak(utter);
    };

    // âœ… æœ‰äº›ç€è¦½å™¨ voice list æœƒæ™šåˆ°ï¼šç­‰ä¸€ä¸‹å†è¬›ï¼ˆé¿å…ç©º voice å°è‡´ errorï¼‰
    setTimeout(speakOnce, 120);
  });
}




function parseQuestions() {
  const raw = questionBank.value;
  const lines = raw.split("\n").map(s => s.trim()).filter(Boolean);

  // é¡Œåº«æ²’è®Šå°±ä¸è¦é‡è¨­ qIndex
  const bankChanged = (raw !== lastQuestionBankText);

  questions = lines.length ? lines : ["Tell us about yourself."];

  if (bankChanged) {
    qIndex = 0; // åªæœ‰é¡Œåº«å…§å®¹è¢«ä½ æ”¹äº†ï¼Œæ‰å›åˆ°ç¬¬ä¸€é¡Œ
    lastQuestionBankText = raw;
  }
}


function currentQuestion() {
  if (!questions.length) parseQuestions();

  // âœ… å¦‚æœå·²ç¶“è¶…éæœ€å¾Œä¸€é¡Œï¼Œå°±å›å‚³ç©ºå­—ä¸²ï¼ˆæˆ–ä½ ä¹Ÿå¯ä»¥å›æœ€å¾Œä¸€é¡Œï¼‰
  if (qIndex >= questions.length) return "";

  return questions[qIndex];
}


function nextQuestion() {
  qIndex = qIndex + 1; // âœ… ä¸è¦å–é¤˜æ•¸ï¼Œæ‰èƒ½èµ°åˆ° questions.length
}

function hasFinishedAllQuestions() {
  return qIndex >= questions.length;
}

/* ---------- Device Handling ---------- */
async function ensurePermissions() {
  // å…ˆæ‹¿ä¸€æ¬¡æ¬Šé™ï¼Œæ‰èƒ½åˆ—å‡º device label
  try {
    const s = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
    s.getTracks().forEach(t=>t.stop());
  } catch (e) {
    // ä½¿ç”¨è€…æ‹’çµ•ä¹Ÿæ²’é—œä¿‚ï¼Œä¹‹å¾Œé‚„æœƒå†è«‹æ±‚ï¼ˆä½†æ²’æœ‰ labelï¼‰
  }
}

async function loadDevices() {
  const devices = await navigator.mediaDevices.enumerateDevices();
  const cams = devices.filter(d=>d.kind === "videoinput");
  const mics = devices.filter(d=>d.kind === "audioinput");

  cameraSelect.innerHTML = cams.map((d,i)=>
    `<option value="${d.deviceId}">${d.label || `Camera ${i+1}`}</option>`
  ).join("") || `<option value="">(no camera found)</option>`;

  micSelect.innerHTML = mics.map((d,i)=>
    `<option value="${d.deviceId}">${d.label || `Microphone ${i+1}`}</option>`
  ).join("") || `<option value="">(no microphone found)</option>`;
}

async function startStream() {
  // âœ… å¦‚æœå·²ç¶“æœ‰ streamï¼Œå°±ç›´æ¥é‡ç”¨ï¼ˆä¸å†è«‹æ±‚æ¬Šé™ï¼‰
  if (mediaStream) {
    mediaStream.getTracks().forEach(t => t.enabled = true);

    const hasVideo = mediaStream.getVideoTracks().length > 0;
    cameraBg.srcObject = hasVideo ? mediaStream : null;

    cameraBg.muted = true;
    await cameraBg.play().catch(()=>{});
    return;
  }

  const camOn = camToggle.value === "on";
  const micOn = micToggle.value === "on";

  const videoConstraint = camOn ? {
    deviceId: cameraSelect.value ? { exact: cameraSelect.value } : undefined
  } : false;

  const audioConstraint = micOn ? {
    deviceId: micSelect.value ? { exact: micSelect.value } : undefined
  } : false;

  if (videoConstraint === false && audioConstraint === false) {
    cameraBg.srcObject = null;
    mediaStream = null;
    return;
  }

  // ğŸ”´ åªæœ‰ç¬¬ä¸€æ¬¡æ‰æœƒè·‘åˆ°é€™è£¡ â†’ åªå•ä¸€æ¬¡æ¬Šé™
  mediaStream = await navigator.mediaDevices.getUserMedia({
    video: videoConstraint,
    audio: audioConstraint
  });

  const hasVideo = mediaStream.getVideoTracks().length > 0;
  cameraBg.srcObject = hasVideo ? mediaStream : null;

  cameraBg.muted = true;
  await cameraBg.play().catch(()=>{});
}


function stopStream() {
  if (!mediaStream) return;
  mediaStream.getTracks().forEach(t=>t.stop());
  mediaStream = null;
}

/* ---------- Recording ---------- */
function pickMimeType() {
  // ç›¡é‡ç”¨ webmï¼ˆChrome/Edge æœ€ç©©ï¼‰
  const candidates = [
    "video/webm;codecs=vp9,opus",
    "video/webm;codecs=vp8,opus",
    "video/webm"
  ];
  for (const t of candidates) {
    if (window.MediaRecorder && MediaRecorder.isTypeSupported(t)) return t;
  }
  return ""; // è®“ç€è¦½å™¨è‡ªå·±æ±ºå®š
}

function startRecording() {
  if (!mediaStream) {
    alert("ç›®å‰ Cam/Mic éƒ½é—œé–‰ï¼Œç„¡æ³•éŒ„å½±éŒ„éŸ³ã€‚è‡³å°‘é–‹å•Ÿå…¶ä¸­ä¸€å€‹ã€‚");
    return;
  }

  recordedChunks = [];
  const mimeType = pickMimeType();
  recorder = new MediaRecorder(mediaStream, mimeType ? { mimeType } : undefined);

  recorder.ondataavailable = (e) => {
    if (e.data && e.data.size > 0) recordedChunks.push(e.data);
  };

  recorder.onstop = () => {
  lastRecordedBlob = new Blob(
    recordedChunks,
    { type: recorder.mimeType || "video/webm" }
  );

  const url = URL.createObjectURL(lastRecordedBlob);
  playbackVideo.src = url;
  showPlayback();
};


  recorder.start(200);
}

function stopRecording() {
  if (recorder && recorder.state !== "inactive") recorder.stop();
}

/* ---------- Screens ---------- */
function showHome() {
  // åˆ‡å›ç•«é¢
  homeScreen.style.display = "flex";
  recordScreen.style.display = "none";
  playbackScreen.style.display = "none";
  stopBtn.style.display = "none";

  // ç‹€æ…‹å› HOME
  setState(State.HOME);

  // åœæ‰æ‰€æœ‰è¨ˆæ™‚èˆ‡éŒ„å½±
  clearTimers();
  stopRecording();
    // âœ… ä¸ stop æ‰ streamï¼Œé¿å…ä¸‹æ¬¡ Start å†æ¬¡è«‹æ±‚æ¬Šé™
  if (mediaStream) {
    mediaStream.getTracks().forEach(t => t.enabled = false);
    
    // âœ… å›é¦–é æ‰å…è¨±ä¸Šä¸‹æ»‘å‹•
  unlockScroll();

  }


  // ===== âœ… é‡é»ï¼šreset éŒ„å½±è¦–è¦ºï¼ˆé¿å…æ®˜ç•™ï¼‰=====
  recBadge.style.display = "none";              // é—œæ‰ REC ğŸ”´
  recordProgressWrap.style.display = "none";    // é—œæ‰é€²åº¦æ¢
  recordProgressFill.style.width = "0%";        // é€²åº¦æ­¸é›¶
  recordScreen.classList.remove("recording");   // ç§»é™¤éŒ„å½±ä¸­çš„èƒŒæ™¯æ•ˆæœ

  // ï¼ˆå¯é¸ä½†å®‰å…¨ï¼‰é‡ç½® timer é¡¯ç¤º
  timerPill.textContent = "00";
    // âœ… ä¾ sessionCompleted æ±ºå®š Start å¯ä¸å¯ä»¥æŒ‰
  if (sessionCompleted) lockStartUI();
  else unlockStartUI();
  // âœ… å›é¦–é æ™‚é¡¯ç¤ºå€‹äººé€£çµ
  if (personalLinks) personalLinks.style.display = "flex";

}


function showRecordScreen() {
  homeScreen.style.display = "none";
  recordScreen.style.display = "block";
  playbackScreen.style.display = "none";

    // âœ… Start å¾Œéš±è—å€‹äººé€£çµ
  if (personalLinks) personalLinks.style.display = "none";
  
    // âœ… Start å¾Œç¦æ­¢ä¸Šä¸‹æ»‘å‹•ï¼ˆæ‰‹æ©Ÿ/é›»è…¦éƒ½ä¸€æ¨£ï¼‰
  lockScroll();

}

function showPlayback() {
    stopSmoothRecordProgress();
  playbackScreen.style.display = "block";
  stopBtn.style.display = "none";
  setState(State.END);
  updateTimerPill(0);
  beep(880, 180);
    // âœ… é—œé–‰ REC è¦–è¦º
  recBadge.style.display = "none";
  recordProgressWrap.style.display = "none";
  recordScreen.classList.remove("recording");

}

function hidePlayback() {
  playbackScreen.style.display = "none";
}

/* ---------- Flow: Prep -> Countdown -> Record -> End ---------- */
function clearTimers() {
  if (prepTimer) clearInterval(prepTimer);
  if (recordTimer) clearInterval(recordTimer);
  prepTimer = null;
  recordTimer = null;
}

async function startRun() {
  parseQuestions();
// âœ… ä¿éšªï¼šå¦‚æœå·²ç¶“ç·´å®Œå…¨éƒ¨é¡Œç›®ï¼Œå°±å›é¦–é 
if (hasFinishedAllQuestions()) {
  showHome();
  return;
}
  const prepSeconds = parseInt(prepTimeInput.value);
  const recordSeconds = parseInt(recordTimeInput.value);

  if (!Number.isFinite(prepSeconds) || prepSeconds < 0) {
    alert("Prep time è«‹è¼¸å…¥ 0 ä»¥ä¸Šç§’æ•¸");
    return;
  }
  if (!Number.isFinite(recordSeconds) || recordSeconds < 1) {
    alert("Record time è«‹è¼¸å…¥ 1 ä»¥ä¸Šç§’æ•¸");
    return;
  }

  // é€²éŒ„è£½ç•«é¢ï¼ˆç«‹åˆ»åˆ‡æ›ï¼‰
  showRecordScreen();

  // âœ… å…ˆ reset è¦–è¦ºï¼ˆé¿å…æ®˜ç•™ï¼‰
  clearTimers();
  stopSmoothRecordProgress();
  countdownOverlay.style.display = "none";
  recBadge.style.display = "none";
  recordProgressWrap.style.display = "none";
  recordProgressFill.style.width = "0%";
  recordScreen.classList.remove("recording");
  stopBtn.style.display = "none";

  // âœ… ä¸€é€²ç•«é¢å°±æŠŠã€Œæ­£ç¢ºçš„ç§’æ•¸ã€å…ˆé¡¯ç¤ºå‡ºä¾†ï¼ˆå·¦ä¸Š/å·¦ä¸‹ç«‹åˆ»æ­£ç¢ºï¼‰
  prepLeft = prepSeconds;
  recordLeft = recordSeconds;

  prepDisplay.textContent = prepLeft;
  recordDisplay.textContent = recordLeft;

  setState(State.PREP);
  updateTimerPill(prepLeft);

  // âœ… é¡Œç›®ä¹Ÿå…ˆé¡¯ç¤ºå‡ºä¾†ï¼ˆé¿å…ç©ºç™½ï¼‰
  const q = currentQuestion();
  questionText.textContent = q;

  // âœ… å…ˆè¬›è©±ï¼ˆè¬›å®Œæ‰é–‹å§‹å€’æ•¸ï¼‰
  await speakQuestion(q);

  // âœ… å†æ¥ä¸Šæ”åƒé ­/éº¥å…‹é¢¨ï¼ˆé¿å…æ¬Šé™å½ˆçª—æ‰“æ–·èªéŸ³ï¼‰
  try {
    await startStream();
  } catch (e) {
    alert("ç„¡æ³•é–‹å•Ÿæ”åƒé ­/éº¥å…‹é¢¨ã€‚è«‹ç¢ºèªæ¬Šé™æˆ–è£ç½®æ˜¯å¦å¯ç”¨ã€‚");
  }

  // âœ… æœ€å¾Œæ‰é–‹å§‹ Prep å€’æ•¸ï¼ˆæœ€å¾Œä¸‰ç§’å¤§ countdownï¼‰
  prepTimer = setInterval(() => {
    if (state !== State.PREP) return;

    if (prepLeft > 0) {
      prepLeft--;
      prepDisplay.textContent = prepLeft;
      updateTimerPill(prepLeft);

      // æœ€å¾Œ 3 ç§’ï¼šå¤§ countdown
      if (prepLeft <= 3 && prepLeft > 0) {
        countdownOverlay.style.display = "flex";
        countdownNumber.textContent = prepLeft;
        beep(740, 140);
      } else {
        countdownOverlay.style.display = "none";
      }
    } else {
      clearInterval(prepTimer);
      countdownOverlay.style.display = "none";
      beginRecordPhase();
    }
  }, 1000);
}




function beginRecordPhase() {
  setState(State.RECORD);
  stopBtn.style.display = "inline-block";
  updateTimerPill(recordLeft);

  // âœ… é–‹å•Ÿ REC è¦–è¦º
  recBadge.style.display = "inline-flex";
  recordProgressWrap.style.display = "block";
  recordProgressFill.style.width = "0%";
  recordScreen.classList.add("recording");

  const total = recordLeft; // ç¸½éŒ„å½±ç§’æ•¸

  // âœ… é–‹å§‹çµ²æ»‘é€²åº¦æ¢ï¼ˆæ¯å¹€æ›´æ–°ï¼‰
  startSmoothRecordProgress(total);

  // é–‹å§‹éŒ„å½±éŒ„éŸ³
  startRecording();

  // å€’æ•¸ï¼ˆä»ç„¶ 1 ç§’æ›´æ–°ä¸€æ¬¡æ–‡å­—ï¼‰
  recordTimer = setInterval(() => {
    if (state !== State.RECORD) return;

    if (recordLeft > 0) {
      recordLeft--;
      recordDisplay.textContent = recordLeft;
      updateTimerPill(recordLeft);
    } else {
      clearInterval(recordTimer);

      // âœ… æ”¶å°¾ï¼šåœæ­¢çµ²æ»‘é€²åº¦æ¢ï¼Œå›ºå®š 100%
      stopSmoothRecordProgress();
      recordProgressFill.style.width = "100%";

      stopRecording();
      // onstop æœƒé€² playback
    }
  }, 1000);
}



/* ---------- UI Events ---------- */
downloadBtn.addEventListener("click", () => {
  if (!lastRecordedBlob) {
    alert("No video to download.");
    return;
  }

  const url = URL.createObjectURL(lastRecordedBlob);
  const a = document.createElement("a");
  a.href = url;

  // æª”åï¼švideo-essay-q1.webm é€™ç¨®
  a.download = `video-essay-q${qIndex}.webm`;

  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);

  // æ¸…æ‰æš«æ™‚ URL
  URL.revokeObjectURL(url);
});

resetSessionBtn.addEventListener("click", () => {
  sessionCompleted = false;
  qIndex = 0;          // å¾ç¬¬ä¸€é¡Œé‡æ–°é–‹å§‹
  unlockStartUI();
});

homeBtn.addEventListener("click", () => {
  hidePlayback();
  showHome();
});

goStart.addEventListener("click", () => {
  if (sessionCompleted) return; // âœ… ç·´å®Œå°±é–ä½
  startRun();
});


backHome.addEventListener("click", () => showHome());


stopBtn.addEventListener("click", () => {
  clearTimers();
  stopRecording();
});

closePlayback.addEventListener("click", () => hidePlayback());

retakeBtn.addEventListener("click", async () => {
  hidePlayback();
  // åŒä¸€é¡Œé‡éŒ„ï¼šé‡æ–°è·‘ä¸€æ¬¡ï¼ˆä¸æ›é¡Œï¼‰
  await startRun();
});

nextBtn.addEventListener("click", async () => {
  hidePlayback();
  nextQuestion();

  // âœ… å¦‚æœæ‰€æœ‰é¡Œç›®éƒ½ç·´å®Œ â†’ å›é¦–é ä¸¦é– Start
  if (hasFinishedAllQuestions()) {
    sessionCompleted = true;
    showHome();
    lockStartUI();
    return;
  }

  await startRun();
});






// åœ¨éŒ„è£½ç•«é¢åˆ‡æ› Cam/Micï¼šé‡æ–°æ‹‰ streamï¼ˆä¸å½±éŸ¿ç›®å‰å·²é–‹å§‹éŒ„çš„é€™æ¬¡ï¼›å»ºè­°åœ¨éŒ„å‰åˆ‡ï¼‰
camToggle.addEventListener("change", async () => {
  if (recordScreen.style.display !== "block") return;
  // è‹¥æ­£åœ¨éŒ„å½±ï¼šå¼·çƒˆå»ºè­°ä¸è¦ä¸­é€”æ›ï¼ˆä¸åŒç€è¦½å™¨è¡Œç‚ºä¸ä¸€è‡´ï¼‰
  if (state === State.RECORD) return;
  try { await startStream(); } catch {}
});

micToggle.addEventListener("change", async () => {
  if (recordScreen.style.display !== "block") return;
  if (state === State.RECORD) return;
  try { await startStream(); } catch {}
});

// é€²å…¥é é¢å…ˆè¦æ¬Šé™ï¼ˆå¯è®“è£ç½®åˆ—è¡¨é¡¯ç¤ºåç¨±ï¼‰
(async function init() {
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´æ”åƒé ­/éº¥å…‹é¢¨ APIã€‚è«‹ç”¨æœ€æ–°ç‰ˆ Chrome/Edgeã€‚");
    return;
  }
  await ensurePermissions();
  await loadDevices();

  // è£ç½®è®Šå‹•ï¼ˆæ’æ‹”ï¼‰æ›´æ–°
  navigator.mediaDevices.addEventListener?.("devicechange", async () => {
    await loadDevices();
  });
})();

// åˆå§‹
showHome();


</script>
</body>
</html>









