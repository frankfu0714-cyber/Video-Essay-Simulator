<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Video Essay Simulator</title>
  <style>
    * { box-sizing: border-box; margin:0; padding:0; }
    body { font-family: "Microsoft JhengHei", system-ui, sans-serif; background:#9B59B6; color:#111; }

    /* ===== Shared ===== */
    .btn {
      border: none; border-radius: 10px;
      padding: 12px 14px; font-weight: 700;
      cursor: pointer;
    }
    .btn-primary { background:#2d1b69; color:#fff; }
    .btn-ghost { background:rgba(255,255,255,0.15); color:#fff; border:1px solid rgba(255,255,255,0.25); }
    .btn-danger { background:#b91c1c; color:#fff; }
    .pill { padding:8px 10px; border-radius:999px; background:rgba(0,0,0,0.35); color:#fff; font-weight:700; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .muted { opacity:0.85; }

    /* ===== Home Screen ===== */
    #homeScreen {
      min-height: 100vh;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      align-items: center;
    }
    .title { text-align:center; color:#fff; }
    .title h1 { font-size: 2.2rem; }
    .card {
      width: min(960px, 100%);
      background: #fff;
      border-radius: 14px;
      padding: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
    }
    .grid {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 720px){ .grid { grid-template-columns: 1fr; } }

    label { display:flex; flex-direction:column; gap:6px; font-weight:700; }
    input, select, textarea {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ddd;
      font-size: 1rem;
    }
    textarea { min-height: 84px; resize: vertical; }

    /* ===== Record Screen ===== */
    #recordScreen {
      display:none;
      position: relative;
      min-height: 100vh;
      overflow: hidden;
      background:#000;
    }

    /* Camera background video */
    #cameraBg {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: contrast(1.05) saturate(1.05);
      transform: scale(1.02);
    }

    /* Dark overlay for readability */
    .shade {
      position:absolute; inset:0;
      background: linear-gradient(
        to bottom,
        rgba(0,0,0,0.55),
        rgba(0,0,0,0.35),
        rgba(0,0,0,0.6)
      );
      pointer-events:none;
    }

    /* Top bar */
    .topbar {
      position:absolute; top:14px; left:14px; right:14px;
      display:flex; justify-content:space-between; align-items:center;
      gap: 10px;
      z-index: 5;
    }

    /* Bottom controls */
    .controls {
      position:absolute; left:14px; right:14px; bottom:14px;
      display:flex; justify-content:space-between; align-items:center;
      gap: 10px; flex-wrap:wrap;
      z-index: 5;
    }

    .panel {
      background: rgba(0,0,0,0.40);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 14px;
      padding: 12px;
      color:#fff;
      backdrop-filter: blur(8px);
    }

    /* Big countdown */
    #countdownOverlay {
      position:absolute; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 6;
    }
    #countdownNumber {
      font-size: min(18vw, 140px);
      color:#fff;
      font-weight: 900;
      text-shadow: 0 10px 40px rgba(0,0,0,0.6);
      letter-spacing: 2px;
    }

    /* Question overlay */
    .questionBox {
      position:absolute;
      left: 14px;
      right: 14px;
      top: 76px;
      z-index: 5;
      display:flex;
      justify-content:center;
    }
    .questionInner {
      width: min(960px, 100%);
      text-align: center;
      font-size: clamp(18px, 2.2vw, 26px);
      font-weight: 800;
      color:#fff;
      padding: 12px 14px;
      border-radius: 14px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.15);
      backdrop-filter: blur(8px);
    }

    /* Playback modal-like screen */
    #playbackScreen {
      display:none;
      position:absolute;
      inset:0;
      z-index: 10;
      background: rgba(0,0,0,0.75);
      padding: 18px;
    }
    .playbackCard {
      width: min(980px, 100%);
      margin: 0 auto;
      background: rgba(0,0,0,0.50);
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 16px;
      padding: 14px;
      color:#fff;
      backdrop-filter: blur(10px);
    }
    #playbackVideo {
      width: 100%;
      max-height: 65vh;
      border-radius: 14px;
      background:#000;
    }
    /* ===== REC pulsing + progress ===== */
#recBadge {
  display: none;
  align-items: center;
  gap: 10px;
}

.recDot {
  width: 12px;
  height: 12px;
  border-radius: 999px;
  background: #ff2d2d;
  box-shadow: 0 0 0 rgba(255,45,45,0.6);
  animation: recPulse 1.1s infinite;
}

@keyframes recPulse {
  0%   { transform: scale(1);   box-shadow: 0 0 0 0 rgba(255,45,45,0.65); opacity: 1; }
  70%  { transform: scale(1.18); box-shadow: 0 0 0 12px rgba(255,45,45,0); opacity: 0.95; }
  100% { transform: scale(1);   box-shadow: 0 0 0 0 rgba(255,45,45,0); opacity: 1; }
}

.recText {
  font-weight: 900;
  letter-spacing: 1px;
}

/* progress bar */
.progressWrap {
  width: min(420px, 60vw);
  height: 10px;
  border-radius: 999px;
  background: rgba(255,255,255,0.18);
  overflow: hidden;
  border: 1px solid rgba(255,255,255,0.18);
}

.progressFill {
  height: 100%;
  width: 0%;
  background: rgba(255,255,255,0.92);
  border-radius: 999px;
  transition: width 0.2s linear;
}

/* "recording vibe" on camera bg */
#recordScreen.recording #cameraBg {
  filter: contrast(1.15) saturate(1.18);
}

/* subtle vignette while recording */
#recordScreen.recording .shade {
  background: radial-gradient(circle at center,
    rgba(0,0,0,0.35),
    rgba(0,0,0,0.55)
  );
}
.commentItem{
  border:1px solid #eee;
  border-radius:12px;
  padding:12px;
  margin-bottom:10px;
}
.commentMeta{
  display:flex;
  justify-content:space-between;
  gap:10px;
  font-weight:900;
}
.commentTime{
  font-weight:700;
  opacity:0.65;
  font-size:0.9rem;
}
.commentBody{
  margin-top:6px;
  line-height:1.6;
  white-space:pre-wrap;
}

/* ===== Personal Links ===== */
.personal-links {
  text-align: center;
}

.link-icons {
  display: flex;
  justify-content: center;
  gap: 26px;
}

.link-icons a {
  width: 42px;
  height: 42px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  background: #f3f3f3;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.link-icons a:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.18);
}

.link-icons img {
  width: 22px;
  height: 22px;
  filter: invert(0.15);
}
/* ===== Personal Links (Centered & Compact) ===== */
.personal-links-wrap {
  display: flex;
  justify-content: center;
  margin-top: 16px;
}

.personal-links {
  width: fit-content;          /* ‚úÖ ÈóúÈçµÔºö‰∏çË¶ÅÊíêÊªø */
  padding: 14px 22px;
  text-align: center;
}

.link-icons {
  display: flex;
  justify-content: center;
  gap: 20px;                   /* Á®çÂæÆÁ∏ÆÁü≠ */
}

.link-icons a {
  width: 38px;                 /* Á∏ÆÂ∞è‰∏ÄÈªû */
  height: 38px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  background: #f3f3f3;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.link-icons a:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 14px rgba(0,0,0,0.18);
}

.link-icons img {
  width: 20px;
  height: 20px;
  filter: invert(0.15);
}

.creator-text {
  margin-top: 8px;
  font-size: 0.9rem;           /* Â≠ó‰πüÁ∏Æ‰∏ÄÈªû */
}

  </style>
</head>

<body>

<!-- =======================
     HOME / SETTINGS SCREEN
     ======================= -->
     <!-- ===== Personal Links ===== -->
<div class="personal-links-wrap" id="personalLinks">
  <div class="card personal-links">
    <div class="link-icons">
      <a href="https://www.linkedin.com/in/goldotaku" target="_blank" aria-label="LinkedIn">
        <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/linkedin.svg" alt="LinkedIn">
      </a>

      <a href="https://youtube.com/@goldotaku403" target="_blank" aria-label="YouTube">
        <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/youtube.svg" alt="YouTube">
      </a>

      <a href="https://linktr.ee/goldotaku" target="_blank" aria-label="Linktree">
        <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/linktree.svg" alt="Linktree">
      </a>
    </div>

    <div class="muted creator-text">
      Connect with GoldOtaku
    </div>
  </div>
</div>

<section id="homeScreen">
  <div class="title">
    <h1>Video Essay Simulator</h1>
    <div class="muted">Start ‚Üí Countdown ‚Üí Record ‚Üí Playback</div>
  </div>

  <div class="card">
    <div class="grid">
      <label>
        Prep time (seconds)
        <input type="number" id="prepTime" value="10" min="0"/>
      </label>

      <label>
        Record time (seconds)
        <input type="number" id="recordTime" value="30" min="1"/>
      </label>

      <label>
        Camera
        <select id="cameraSelect">
          <option value="">(loading devices...)</option>
        </select>
      </label>

      <label>
        Microphone
        <select id="micSelect">
          <option value="">(loading devices...)</option>
        </select>
      </label>
    </div>

    <div style="height:12px"></div>

    <label>
      Question bank (one per line)
      <textarea id="questionBank">Tell us about a time you failed and what you learned.
Why MBA, and why now?
Describe a time you led a team through uncertainty.
What is your short-term goal, and why this school?
Tell us about a time you received tough feedback.</textarea>
    </label>

    <div style="height:14px"></div>

    <div class="row" style="justify-content:space-between;">
  <div class="muted" id="homeHint">Tip: allow camera/mic permission when prompted.</div>

  <div class="row">
    <button class="btn btn-ghost" id="resetSessionBtn" style="display:none;">Reset Session</button>
    <button class="btn btn-primary" id="goStart">Start</button>
  </div>
</div>

  </div>
  <div class="card" style="margin-top:16px;">
  <h2 style="margin-bottom:10px;">Comments</h2>

  <div class="grid" style="grid-template-columns: 1fr 1fr; align-items:end;">
    <label>
      Name
      <input id="commentName" maxlength="30" placeholder="e.g., Frank"/>
    </label>

    <label>
      Your feedback
      <input id="commentText" maxlength="300" placeholder="What you liked / what to improve..."/>
    </label>
  </div>

  <div style="height:12px"></div>

  <div class="row" style="justify-content:space-between;">
    <div class="muted" id="commentStatus">Be kind and constructive üôÇ</div>
    <button class="btn btn-primary" id="submitComment">Post</button>
  </div>

  <div style="height:14px"></div>
  <div id="commentList"></div>
</div>

</section>


<!-- =======================
     RECORDING SCREEN
     ======================= -->
<section id="recordScreen">
  <video id="cameraBg" autoplay playsinline muted></video>
  <div class="shade"></div>

  <div class="topbar">
    <div class="row">
  <span class="pill" id="statePill">IDLE</span>
  <span class="pill" id="timerPill">00</span>

  <!-- ‚úÖ REC pulsing badge -->
  <span class="pill" id="recBadge">
    <span class="recDot"></span>
    <span class="recText">REC</span>
  </span>

  <!-- ‚úÖ progress bar (recording) -->
  <div class="progressWrap" id="recordProgressWrap" style="display:none;">
    <div class="progressFill" id="recordProgressFill"></div>
  </div>
</div>


    <div class="row panel">
      <label style="font-weight:800; color:#fff;">
        Cam
        <select id="camToggle">
          <option value="on" selected>On</option>
          <option value="off">Off</option>
        </select>
      </label>

      <label style="font-weight:800; color:#fff;">
        Mic
        <select id="micToggle">
          <option value="on" selected>On</option>
          <option value="off">Off</option>
        </select>
      </label>

      <button class="btn btn-ghost" id="backHome">Back</button>
    </div>
  </div>

  <div class="questionBox">
    <div class="questionInner" id="questionText">Question will appear here.</div>
  </div>

  <div id="countdownOverlay">
    <div id="countdownNumber">3</div>
  </div>

  <div class="controls">
    <div class="panel row">
      <div><b>Prep</b>: <span id="prepDisplay">10</span>s</div>
      <div><b>Record</b>: <span id="recordDisplay">30</span>s</div>
    </div>

    <div class="row">
      <button class="btn btn-danger" id="stopBtn" style="display:none;">Stop</button>
    </div>
  </div>

  <!-- Playback overlay -->
  <div id="playbackScreen">
    <div class="playbackCard">
      <div class="row" style="justify-content:space-between; margin-bottom:10px;">
        <div style="font-weight:900; font-size:1.1rem;">Playback</div>
        <div class="row">
          <button class="btn btn-ghost" id="retakeBtn">Retake</button>
          <button class="btn btn-primary" id="nextBtn">Next Question</button>
          <button class="btn btn-ghost" id="homeBtn">Home</button>
          <button class="btn btn-ghost" id="downloadBtn">DOWNLOAD</button>
          <button class="btn btn-ghost" id="closePlayback">Close</button>
        </div>
      </div>

      <video id="playbackVideo" controls playsinline></video>
      <div class="muted" style="margin-top:10px;">
        If playback is blank on some browsers, try Chrome/Edge on desktop.
      </div>
    </div>
  </div>
</section>

<script type="module">
  // Firebase SDK (modular)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import {
    getFirestore, collection, addDoc, serverTimestamp,
    query, orderBy, onSnapshot, limit
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  // ‚úÖ 1) ‰Ω†Ë¶ÅÊääÈÄôË£°ÊèõÊàê‰Ω†Ëá™Â∑±ÁöÑ Firebase configÔºàÂæû Firebase Console Ë§áË£ΩÔºâ
  const firebaseConfig = {
  apiKey: "AIzaSyAoCsZKLfwPVlQ-4rNukikuAgzR3_oLfmg",
  authDomain: "video-essay-simulator.firebaseapp.com",
  projectId: "video-essay-simulator",
  storageBucket: "video-essay-simulator.firebasestorage.app",
  messagingSenderId: "455293481653",
  appId: "1:455293481653:web:32d2e02c23cf9a68a1c4fc",
  measurementId: "G-N6X8VQ3Z6F"
    
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // DOM
  const commentName = document.getElementById("commentName");
  const commentText = document.getElementById("commentText");
  const submitComment = document.getElementById("submitComment");
  const commentList = document.getElementById("commentList");
  const commentStatus = document.getElementById("commentStatus");

  // ËÆÄÂèñÁïôË®ÄÔºàÊúÄÊñ∞ 50 ÂâáÔºâ
  const commentsRef = collection(db, "comments");
  const q = query(commentsRef, orderBy("createdAt", "desc"), limit(50));

  onSnapshot(q, (snap) => {
    commentList.innerHTML = "";
    snap.forEach(doc => {
      const d = doc.data();
      const name = (d.name || "Anonymous").replaceAll("<", "&lt;");
      const text = (d.text || "").replaceAll("<", "&lt;");
      const ts = d.createdAt?.toDate ? d.createdAt.toDate() : null;
      const timeStr = ts ? ts.toLocaleString() : "";

      const el = document.createElement("div");
      el.className = "commentItem";
      el.innerHTML = `
        <div class="commentMeta">
          <div>${name}</div>
          <div class="commentTime">${timeStr}</div>
        </div>
        <div class="commentBody">${text}</div>
      `;
      commentList.appendChild(el);
    });
  });

  // Áôº‰ΩàÁïôË®Ä
  submitComment.addEventListener("click", async () => {
    const name = (commentName.value || "").trim().slice(0, 30);
    const text = (commentText.value || "").trim().slice(0, 300);

    if (!text) {
      commentStatus.textContent = "Please write something üôÇ";
      return;
    }

    submitComment.disabled = true;
    submitComment.style.opacity = "0.6";
    commentStatus.textContent = "Posting...";

    try {
      await addDoc(commentsRef, {
        name: name || "Anonymous",
        text,
        createdAt: serverTimestamp()
      });

      commentText.value = "";
      commentStatus.textContent = "Posted ‚úÖ";
      setTimeout(() => (commentStatus.textContent = "Be kind and constructive üôÇ"), 1200);
    } catch (e) {
      commentStatus.textContent = "Failed to post. Please try again.";
      console.error(e);
    } finally {
      submitComment.disabled = false;
      submitComment.style.opacity = "1";
    }
  });
</script>


<script>
/* =========================================
   Video Essay Simulator (Camera Background + Record + Playback)
   ========================================= */

const State = { HOME:"HOME", PREP:"PREP", COUNTDOWN:"COUNTDOWN", RECORD:"RECORD", END:"END" };
let state = State.HOME;

let mediaStream = null;
let recorder = null;
let recordedChunks = [];
let recordTimer = null;
let recordStartTs = 0;
let progressRafId = null;
let prepTimer = null;
let hasEverGrantedMedia = false;
let lastRecordedBlob = null;



let prepLeft = 0;
let recordLeft = 0;

let questions = [];
let qIndex = 0;
let sessionCompleted = false;


let lastQuestionBankText = "";

// DOM
const downloadBtn = document.getElementById("downloadBtn");

const resetSessionBtn = document.getElementById("resetSessionBtn");
const homeHint = document.getElementById("homeHint");

const homeBtn = document.getElementById("homeBtn");

const recBadge = document.getElementById("recBadge");
const recordProgressWrap = document.getElementById("recordProgressWrap");
const recordProgressFill = document.getElementById("recordProgressFill");

const homeScreen = document.getElementById("homeScreen");
const recordScreen = document.getElementById("recordScreen");

const prepTimeInput = document.getElementById("prepTime");
const recordTimeInput = document.getElementById("recordTime");
const questionBank = document.getElementById("questionBank");

const cameraSelect = document.getElementById("cameraSelect");
const micSelect = document.getElementById("micSelect");

const goStart = document.getElementById("goStart");
const personalLinks = document.getElementById("personalLinks");
const backHome = document.getElementById("backHome");

const cameraBg = document.getElementById("cameraBg");
const questionText = document.getElementById("questionText");

const statePill = document.getElementById("statePill");
const timerPill = document.getElementById("timerPill");

const prepDisplay = document.getElementById("prepDisplay");
const recordDisplay = document.getElementById("recordDisplay");

const camToggle = document.getElementById("camToggle");
const micToggle = document.getElementById("micToggle");

const countdownOverlay = document.getElementById("countdownOverlay");
const countdownNumber = document.getElementById("countdownNumber");

const stopBtn = document.getElementById("stopBtn");

const playbackScreen = document.getElementById("playbackScreen");
const playbackVideo = document.getElementById("playbackVideo");
const closePlayback = document.getElementById("closePlayback");
const retakeBtn = document.getElementById("retakeBtn");
const nextBtn = document.getElementById("nextBtn");

/* ---------- Utilities ---------- */
function lockStartUI() {
  goStart.disabled = true;
  goStart.style.opacity = "0.55";
  goStart.style.cursor = "not-allowed";

  homeHint.textContent = "‚úÖ Resetting‚Ä¶ please wait a few seconds.";
  resetSessionBtn.style.display = "inline-block";
}

function unlockStartUI() {
  goStart.disabled = false;
  goStart.style.opacity = "1";
  goStart.style.cursor = "pointer";

  homeHint.textContent = "Tip: allow camera/mic permission when prompted.";
  resetSessionBtn.style.display = "none";
}

function startSmoothRecordProgress(totalSeconds) {
  // ÂèñÊ∂àËàäÁöÑÂãïÁï´
  if (progressRafId) cancelAnimationFrame(progressRafId);

  recordStartTs = performance.now();
  const totalMs = totalSeconds * 1000;

  const tick = () => {
    if (state !== State.RECORD) return; // ÈùûÈåÑÂΩ±ÁãÄÊÖãÂ∞±ÂÅúÊ≠¢Êõ¥Êñ∞

    const elapsed = performance.now() - recordStartTs;
    const pct = totalMs > 0 ? Math.min(100, (elapsed / totalMs) * 100) : 0;
    recordProgressFill.style.width = pct.toFixed(2) + "%";

    progressRafId = requestAnimationFrame(tick);
  };

  progressRafId = requestAnimationFrame(tick);
}

function stopSmoothRecordProgress() {
  if (progressRafId) cancelAnimationFrame(progressRafId);
  progressRafId = null;
}

function setState(next) {
  state = next;
  statePill.textContent = next;
}

function pad2(n){ return String(n).padStart(2,"0"); }

function updateTimerPill(sec) {
  timerPill.textContent = `${pad2(sec)}`;
}

function beep(freq=660, ms=160){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.frequency.value = freq;
    gain.gain.value = 0.12;
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.start();
    setTimeout(()=>{ osc.stop(); ctx.close(); }, ms);
  } catch {}
}

function speakQuestion(text) {
  return new Promise((resolve) => {
    if (!("speechSynthesis" in window)) return resolve();

    const synth = window.speechSynthesis;

    // ‚úÖ Ê∏ÖÊéâ‰∏ä‰∏ÄÂè• + Âº∑Âà∂ resumeÔºàChrome Â∏∏ÊúÉÂÅúÂú® pausedÔºâ
    synth.cancel();
    synth.resume();

    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = "en-US";
    utter.rate = 0.95;
    utter.pitch = 0.7;
    utter.volume = 1;

    let finished = false;
    let tried = 0;

    const finish = () => {
      if (finished) return;
      finished = true;
      resolve();
    };

    const pickVoice = () => {
      const voices = synth.getVoices() || [];
      const preferred =
        voices.find(v => (v.lang || "").toLowerCase().startsWith("en") &&
          /(male|man|alex|david|daniel|tom|fred|george)/i.test(v.name)
        ) ||
        voices.find(v => (v.lang || "").toLowerCase().startsWith("en"));
      if (preferred) utter.voice = preferred;
    };

    const speakOnce = () => {
      if (finished) return;
      tried++;

      synth.cancel();
      synth.resume();
      pickVoice();

      // ‚úÖ ÁúüÊ≠£ÈñãÂßãË¨õÊâçÁÆóÊàêÂäüÔºà‰∏çÊúÉÁ´ãÂàª resolveÔºâ
      utter.onend = finish;
      utter.onerror = () => {
        // ‚úÖ Â§±ÊïóÂ∞± retry ‰∏ÄÊ¨°ÔºàChrome/Win Â∏∏Ë¶ãÁ¨¨‰∏ÄÊ¨°ÊúÉ errorÔºâ
        if (tried < 2) {
          setTimeout(speakOnce, 200);
        } else {
          finish(); // ÁúüÁöÑ‰∏çË°åÂ∞±Âà•Âç°‰ΩèÊµÅÁ®ã
        }
      };

      synth.speak(utter);
    };

    // ‚úÖ Êúâ‰∫õÁÄèË¶ΩÂô® voice list ÊúÉÊôöÂà∞ÔºöÁ≠â‰∏Ä‰∏ãÂÜçË¨õÔºàÈÅøÂÖçÁ©∫ voice Â∞éËá¥ errorÔºâ
    setTimeout(speakOnce, 120);
  });
}




function parseQuestions() {
  const raw = questionBank.value;
  const lines = raw.split("\n").map(s => s.trim()).filter(Boolean);

  // È°åÂ∫´Ê≤íËÆäÂ∞±‰∏çË¶ÅÈáçË®≠ qIndex
  const bankChanged = (raw !== lastQuestionBankText);

  questions = lines.length ? lines : ["Tell us about yourself."];

  if (bankChanged) {
    qIndex = 0; // Âè™ÊúâÈ°åÂ∫´ÂÖßÂÆπË¢´‰Ω†Êîπ‰∫ÜÔºåÊâçÂõûÂà∞Á¨¨‰∏ÄÈ°å
    lastQuestionBankText = raw;
  }
}


function currentQuestion() {
  if (!questions.length) parseQuestions();

  // ‚úÖ Â¶ÇÊûúÂ∑≤Á∂ìË∂ÖÈÅéÊúÄÂæå‰∏ÄÈ°åÔºåÂ∞±ÂõûÂÇ≥Á©∫Â≠ó‰∏≤ÔºàÊàñ‰Ω†‰πüÂèØ‰ª•ÂõûÊúÄÂæå‰∏ÄÈ°åÔºâ
  if (qIndex >= questions.length) return "";

  return questions[qIndex];
}


function nextQuestion() {
  qIndex = qIndex + 1; // ‚úÖ ‰∏çË¶ÅÂèñÈ§òÊï∏ÔºåÊâçËÉΩËµ∞Âà∞ questions.length
}

function hasFinishedAllQuestions() {
  return qIndex >= questions.length;
}

/* ---------- Device Handling ---------- */
async function ensurePermissions() {
  // ÂÖàÊãø‰∏ÄÊ¨°Ê¨äÈôêÔºåÊâçËÉΩÂàóÂá∫ device label
  try {
    const s = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
    s.getTracks().forEach(t=>t.stop());
  } catch (e) {
    // ‰ΩøÁî®ËÄÖÊãíÁµï‰πüÊ≤íÈóú‰øÇÔºå‰πãÂæåÈÇÑÊúÉÂÜçË´ãÊ±ÇÔºà‰ΩÜÊ≤íÊúâ labelÔºâ
  }
}

async function loadDevices() {
  const devices = await navigator.mediaDevices.enumerateDevices();
  const cams = devices.filter(d=>d.kind === "videoinput");
  const mics = devices.filter(d=>d.kind === "audioinput");

  cameraSelect.innerHTML = cams.map((d,i)=>
    `<option value="${d.deviceId}">${d.label || `Camera ${i+1}`}</option>`
  ).join("") || `<option value="">(no camera found)</option>`;

  micSelect.innerHTML = mics.map((d,i)=>
    `<option value="${d.deviceId}">${d.label || `Microphone ${i+1}`}</option>`
  ).join("") || `<option value="">(no microphone found)</option>`;
}

async function startStream() {
  // ‚úÖ Â¶ÇÊûúÂ∑≤Á∂ìÊúâ streamÔºåÂ∞±Áõ¥Êé•ÈáçÁî®Ôºà‰∏çÂÜçË´ãÊ±ÇÊ¨äÈôêÔºâ
  if (mediaStream) {
    mediaStream.getTracks().forEach(t => t.enabled = true);

    const hasVideo = mediaStream.getVideoTracks().length > 0;
    cameraBg.srcObject = hasVideo ? mediaStream : null;

    cameraBg.muted = true;
    await cameraBg.play().catch(()=>{});
    return;
  }

  const camOn = camToggle.value === "on";
  const micOn = micToggle.value === "on";

  const videoConstraint = camOn ? {
    deviceId: cameraSelect.value ? { exact: cameraSelect.value } : undefined
  } : false;

  const audioConstraint = micOn ? {
    deviceId: micSelect.value ? { exact: micSelect.value } : undefined
  } : false;

  if (videoConstraint === false && audioConstraint === false) {
    cameraBg.srcObject = null;
    mediaStream = null;
    return;
  }

  // üî¥ Âè™ÊúâÁ¨¨‰∏ÄÊ¨°ÊâçÊúÉË∑ëÂà∞ÈÄôË£° ‚Üí Âè™Âïè‰∏ÄÊ¨°Ê¨äÈôê
  mediaStream = await navigator.mediaDevices.getUserMedia({
    video: videoConstraint,
    audio: audioConstraint
  });

  const hasVideo = mediaStream.getVideoTracks().length > 0;
  cameraBg.srcObject = hasVideo ? mediaStream : null;

  cameraBg.muted = true;
  await cameraBg.play().catch(()=>{});
}


function stopStream() {
  if (!mediaStream) return;
  mediaStream.getTracks().forEach(t=>t.stop());
  mediaStream = null;
}

/* ---------- Recording ---------- */
function pickMimeType() {
  // Áõ°ÈáèÁî® webmÔºàChrome/Edge ÊúÄÁ©©Ôºâ
  const candidates = [
    "video/webm;codecs=vp9,opus",
    "video/webm;codecs=vp8,opus",
    "video/webm"
  ];
  for (const t of candidates) {
    if (window.MediaRecorder && MediaRecorder.isTypeSupported(t)) return t;
  }
  return ""; // ËÆìÁÄèË¶ΩÂô®Ëá™Â∑±Ê±∫ÂÆö
}

function startRecording() {
  if (!mediaStream) {
    alert("ÁõÆÂâç Cam/Mic ÈÉΩÈóúÈñâÔºåÁÑ°Ê≥ïÈåÑÂΩ±ÈåÑÈü≥„ÄÇËá≥Â∞ëÈñãÂïüÂÖ∂‰∏≠‰∏ÄÂÄã„ÄÇ");
    return;
  }

  recordedChunks = [];
  const mimeType = pickMimeType();
  recorder = new MediaRecorder(mediaStream, mimeType ? { mimeType } : undefined);

  recorder.ondataavailable = (e) => {
    if (e.data && e.data.size > 0) recordedChunks.push(e.data);
  };

  recorder.onstop = () => {
  lastRecordedBlob = new Blob(
    recordedChunks,
    { type: recorder.mimeType || "video/webm" }
  );

  const url = URL.createObjectURL(lastRecordedBlob);
  playbackVideo.src = url;
  showPlayback();
};


  recorder.start(200);
}

function stopRecording() {
  if (recorder && recorder.state !== "inactive") recorder.stop();
}

/* ---------- Screens ---------- */
function showHome() {
  // ÂàáÂõûÁï´Èù¢
  homeScreen.style.display = "flex";
  recordScreen.style.display = "none";
  playbackScreen.style.display = "none";
  stopBtn.style.display = "none";

  // ÁãÄÊÖãÂõû HOME
  setState(State.HOME);

  // ÂÅúÊéâÊâÄÊúâË®àÊôÇËàáÈåÑÂΩ±
  clearTimers();
  stopRecording();
    // ‚úÖ ‰∏ç stop Êéâ streamÔºåÈÅøÂÖç‰∏ãÊ¨° Start ÂÜçÊ¨°Ë´ãÊ±ÇÊ¨äÈôê
  if (mediaStream) {
    mediaStream.getTracks().forEach(t => t.enabled = false);
  }


  // ===== ‚úÖ ÈáçÈªûÔºöreset ÈåÑÂΩ±Ë¶ñË¶∫ÔºàÈÅøÂÖçÊÆòÁïôÔºâ=====
  recBadge.style.display = "none";              // ÈóúÊéâ REC üî¥
  recordProgressWrap.style.display = "none";    // ÈóúÊéâÈÄ≤Â∫¶Ê¢ù
  recordProgressFill.style.width = "0%";        // ÈÄ≤Â∫¶Ê≠∏Èõ∂
  recordScreen.classList.remove("recording");   // ÁßªÈô§ÈåÑÂΩ±‰∏≠ÁöÑËÉåÊôØÊïàÊûú

  // ÔºàÂèØÈÅ∏‰ΩÜÂÆâÂÖ®ÔºâÈáçÁΩÆ timer È°ØÁ§∫
  timerPill.textContent = "00";
    // ‚úÖ ‰æù sessionCompleted Ê±∫ÂÆö Start ÂèØ‰∏çÂèØ‰ª•Êåâ
  if (sessionCompleted) lockStartUI();
  else unlockStartUI();
  // ‚úÖ ÂõûÈ¶ñÈ†ÅÊôÇÈ°ØÁ§∫ÂÄã‰∫∫ÈÄ£Áµê
  if (personalLinks) personalLinks.style.display = "flex";

}


function showRecordScreen() {
  homeScreen.style.display = "none";
  recordScreen.style.display = "block";
  playbackScreen.style.display = "none";

    // ‚úÖ Start ÂæåÈö±ËóèÂÄã‰∫∫ÈÄ£Áµê
  if (personalLinks) personalLinks.style.display = "none";
}

function showPlayback() {
    stopSmoothRecordProgress();
  playbackScreen.style.display = "block";
  stopBtn.style.display = "none";
  setState(State.END);
  updateTimerPill(0);
  beep(880, 180);
    // ‚úÖ ÈóúÈñâ REC Ë¶ñË¶∫
  recBadge.style.display = "none";
  recordProgressWrap.style.display = "none";
  recordScreen.classList.remove("recording");

}

function hidePlayback() {
  playbackScreen.style.display = "none";
}

/* ---------- Flow: Prep -> Countdown -> Record -> End ---------- */
function clearTimers() {
  if (prepTimer) clearInterval(prepTimer);
  if (recordTimer) clearInterval(recordTimer);
  prepTimer = null;
  recordTimer = null;
}

async function startRun() {
  parseQuestions();
// ‚úÖ ‰øùÈö™ÔºöÂ¶ÇÊûúÂ∑≤Á∂ìÁ∑¥ÂÆåÂÖ®ÈÉ®È°åÁõÆÔºåÂ∞±ÂõûÈ¶ñÈ†Å
if (hasFinishedAllQuestions()) {
  showHome();
  return;
}
  const prepSeconds = parseInt(prepTimeInput.value);
  const recordSeconds = parseInt(recordTimeInput.value);

  if (!Number.isFinite(prepSeconds) || prepSeconds < 0) {
    alert("Prep time Ë´ãËº∏ÂÖ• 0 ‰ª•‰∏äÁßíÊï∏");
    return;
  }
  if (!Number.isFinite(recordSeconds) || recordSeconds < 1) {
    alert("Record time Ë´ãËº∏ÂÖ• 1 ‰ª•‰∏äÁßíÊï∏");
    return;
  }

  // ÈÄ≤ÈåÑË£ΩÁï´Èù¢ÔºàÁ´ãÂàªÂàáÊèõÔºâ
  showRecordScreen();

  // ‚úÖ ÂÖà reset Ë¶ñË¶∫ÔºàÈÅøÂÖçÊÆòÁïôÔºâ
  clearTimers();
  stopSmoothRecordProgress();
  countdownOverlay.style.display = "none";
  recBadge.style.display = "none";
  recordProgressWrap.style.display = "none";
  recordProgressFill.style.width = "0%";
  recordScreen.classList.remove("recording");
  stopBtn.style.display = "none";

  // ‚úÖ ‰∏ÄÈÄ≤Áï´Èù¢Â∞±Êää„ÄåÊ≠£Á¢∫ÁöÑÁßíÊï∏„ÄçÂÖàÈ°ØÁ§∫Âá∫‰æÜÔºàÂ∑¶‰∏ä/Â∑¶‰∏ãÁ´ãÂàªÊ≠£Á¢∫Ôºâ
  prepLeft = prepSeconds;
  recordLeft = recordSeconds;

  prepDisplay.textContent = prepLeft;
  recordDisplay.textContent = recordLeft;

  setState(State.PREP);
  updateTimerPill(prepLeft);

  // ‚úÖ È°åÁõÆ‰πüÂÖàÈ°ØÁ§∫Âá∫‰æÜÔºàÈÅøÂÖçÁ©∫ÁôΩÔºâ
  const q = currentQuestion();
  questionText.textContent = q;

  // ‚úÖ ÂÖàË¨õË©±ÔºàË¨õÂÆåÊâçÈñãÂßãÂÄíÊï∏Ôºâ
  await speakQuestion(q);

  // ‚úÖ ÂÜçÊé•‰∏äÊîùÂÉèÈ†≠/È∫•ÂÖãÈ¢®ÔºàÈÅøÂÖçÊ¨äÈôêÂΩàÁ™óÊâìÊñ∑Ë™ûÈü≥Ôºâ
  try {
    await startStream();
  } catch (e) {
    alert("ÁÑ°Ê≥ïÈñãÂïüÊîùÂÉèÈ†≠/È∫•ÂÖãÈ¢®„ÄÇË´ãÁ¢∫Ë™çÊ¨äÈôêÊàñË£ùÁΩÆÊòØÂê¶ÂèØÁî®„ÄÇ");
  }

  // ‚úÖ ÊúÄÂæåÊâçÈñãÂßã Prep ÂÄíÊï∏ÔºàÊúÄÂæå‰∏âÁßíÂ§ß countdownÔºâ
  prepTimer = setInterval(() => {
    if (state !== State.PREP) return;

    if (prepLeft > 0) {
      prepLeft--;
      prepDisplay.textContent = prepLeft;
      updateTimerPill(prepLeft);

      // ÊúÄÂæå 3 ÁßíÔºöÂ§ß countdown
      if (prepLeft <= 3 && prepLeft > 0) {
        countdownOverlay.style.display = "flex";
        countdownNumber.textContent = prepLeft;
        beep(740, 140);
      } else {
        countdownOverlay.style.display = "none";
      }
    } else {
      clearInterval(prepTimer);
      countdownOverlay.style.display = "none";
      beginRecordPhase();
    }
  }, 1000);
}




function beginRecordPhase() {
  setState(State.RECORD);
  stopBtn.style.display = "inline-block";
  updateTimerPill(recordLeft);

  // ‚úÖ ÈñãÂïü REC Ë¶ñË¶∫
  recBadge.style.display = "inline-flex";
  recordProgressWrap.style.display = "block";
  recordProgressFill.style.width = "0%";
  recordScreen.classList.add("recording");

  const total = recordLeft; // Á∏ΩÈåÑÂΩ±ÁßíÊï∏

  // ‚úÖ ÈñãÂßãÁµ≤ÊªëÈÄ≤Â∫¶Ê¢ùÔºàÊØèÂπÄÊõ¥Êñ∞Ôºâ
  startSmoothRecordProgress(total);

  // ÈñãÂßãÈåÑÂΩ±ÈåÑÈü≥
  startRecording();

  // ÂÄíÊï∏Ôºà‰ªçÁÑ∂ 1 ÁßíÊõ¥Êñ∞‰∏ÄÊ¨°ÊñáÂ≠óÔºâ
  recordTimer = setInterval(() => {
    if (state !== State.RECORD) return;

    if (recordLeft > 0) {
      recordLeft--;
      recordDisplay.textContent = recordLeft;
      updateTimerPill(recordLeft);
    } else {
      clearInterval(recordTimer);

      // ‚úÖ Êî∂Â∞æÔºöÂÅúÊ≠¢Áµ≤ÊªëÈÄ≤Â∫¶Ê¢ùÔºåÂõ∫ÂÆö 100%
      stopSmoothRecordProgress();
      recordProgressFill.style.width = "100%";

      stopRecording();
      // onstop ÊúÉÈÄ≤ playback
    }
  }, 1000);
}



/* ---------- UI Events ---------- */
downloadBtn.addEventListener("click", () => {
  if (!lastRecordedBlob) {
    alert("No video to download.");
    return;
  }

  const url = URL.createObjectURL(lastRecordedBlob);
  const a = document.createElement("a");
  a.href = url;

  // Ê™îÂêçÔºövideo-essay-q1.webm ÈÄôÁ®Æ
  a.download = `video-essay-q${qIndex}.webm`;

  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);

  // Ê∏ÖÊéâÊö´ÊôÇ URL
  URL.revokeObjectURL(url);
});

resetSessionBtn.addEventListener("click", () => {
  sessionCompleted = false;
  qIndex = 0;          // ÂæûÁ¨¨‰∏ÄÈ°åÈáçÊñ∞ÈñãÂßã
  unlockStartUI();
});

homeBtn.addEventListener("click", () => {
  hidePlayback();
  showHome();
});

goStart.addEventListener("click", () => {
  if (sessionCompleted) return; // ‚úÖ Á∑¥ÂÆåÂ∞±Èéñ‰Ωè
  startRun();
});


backHome.addEventListener("click", () => showHome());


stopBtn.addEventListener("click", () => {
  clearTimers();
  stopRecording();
});

closePlayback.addEventListener("click", () => hidePlayback());

retakeBtn.addEventListener("click", async () => {
  hidePlayback();
  // Âêå‰∏ÄÈ°åÈáçÈåÑÔºöÈáçÊñ∞Ë∑ë‰∏ÄÊ¨°Ôºà‰∏çÊèõÈ°åÔºâ
  await startRun();
});

nextBtn.addEventListener("click", async () => {
  hidePlayback();
  nextQuestion();

  // ‚úÖ Â¶ÇÊûúÊâÄÊúâÈ°åÁõÆÈÉΩÁ∑¥ÂÆå ‚Üí ÂõûÈ¶ñÈ†Å‰∏¶Èéñ Start
  if (hasFinishedAllQuestions()) {
    sessionCompleted = true;
    showHome();
    lockStartUI();
    return;
  }

  await startRun();
});






// Âú®ÈåÑË£ΩÁï´Èù¢ÂàáÊèõ Cam/MicÔºöÈáçÊñ∞Êãâ streamÔºà‰∏çÂΩ±ÈüøÁõÆÂâçÂ∑≤ÈñãÂßãÈåÑÁöÑÈÄôÊ¨°ÔºõÂª∫Ë≠∞Âú®ÈåÑÂâçÂàáÔºâ
camToggle.addEventListener("change", async () => {
  if (recordScreen.style.display !== "block") return;
  // Ëã•Ê≠£Âú®ÈåÑÂΩ±ÔºöÂº∑ÁÉàÂª∫Ë≠∞‰∏çË¶Å‰∏≠ÈÄîÊèõÔºà‰∏çÂêåÁÄèË¶ΩÂô®Ë°åÁÇ∫‰∏ç‰∏ÄËá¥Ôºâ
  if (state === State.RECORD) return;
  try { await startStream(); } catch {}
});

micToggle.addEventListener("change", async () => {
  if (recordScreen.style.display !== "block") return;
  if (state === State.RECORD) return;
  try { await startStream(); } catch {}
});

// ÈÄ≤ÂÖ•È†ÅÈù¢ÂÖàË¶ÅÊ¨äÈôêÔºàÂèØËÆìË£ùÁΩÆÂàóË°®È°ØÁ§∫ÂêçÁ®±Ôºâ
(async function init() {
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    alert("Ê≠§ÁÄèË¶ΩÂô®‰∏çÊîØÊè¥ÊîùÂÉèÈ†≠/È∫•ÂÖãÈ¢® API„ÄÇË´ãÁî®ÊúÄÊñ∞Áâà Chrome/Edge„ÄÇ");
    return;
  }
  await ensurePermissions();
  await loadDevices();

  // Ë£ùÁΩÆËÆäÂãïÔºàÊèíÊãîÔºâÊõ¥Êñ∞
  navigator.mediaDevices.addEventListener?.("devicechange", async () => {
    await loadDevices();
  });
})();

// ÂàùÂßã
showHome();


</script>
</body>
</html>

